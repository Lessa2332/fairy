<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ü¶∑ AR Nikadent-Family</title>

    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script> 
    
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* ... (CSS –°–¢–ò–õ–Ü –ó–ê–õ–ò–®–ê–Æ–¢–¨–°–Ø –Ø–ö –£ –ü–û–ü–ï–†–ï–î–ù–Ü–ô –í–Ü–î–ü–û–í–Ü–î–Ü) ... */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'Comic Neue', 'Comic Sans MS', cursive, sans-serif;
            text-transform: none;
            background: #f0f0f0;
        }
        a-scene {
            width: 100% !important;
            height: 100% !important;
            position: fixed;
            top: 0;
            left: 0;
            background: transparent;
        }
        .arjs-loader {
            height: 100%;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            background: rgba(255, 255, 255, 0.95);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #0057B8;
            font-size: 1.5em;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
            font-family: 'Comic Neue', sans-serif;
            text-transform: none;
        }
        .ui-btn {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            padding: 14px 25px;
            border-radius: 30px;
            font-size: 1.1em;
            font-weight: bold;
            text-decoration: none;
            z-index: 1000;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
            display: none;
            font-family: 'Comic Neue', sans-serif;
            text-transform: none;
            white-space: nowrap;
        }
        #startGame1Btn { bottom: 180px; background: linear-gradient(45deg, #FF6B6B, #FF8E53); color: white; }
        #startGame2Btn { bottom: 110px; background: linear-gradient(45deg, #87CEFA, #4682B4); color: white; }
        #stopBtn { bottom: 180px; background: linear-gradient(45deg, #ff4757, #ff6b81); color: white; }
        #rulesBtn { bottom: 250px; background: linear-gradient(45deg, #FFD700, #FFA500); color: black; padding: 14px 20px; }
        #soundBtn { bottom: 320px; background: linear-gradient(45deg, #00CED1, #20B2AA); color: white; }
        .corner-btn {
            position: fixed;
            bottom: 20px;
            padding: 10px 18px;
            border-radius: 25px;
            font-size: 0.95em;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            display: none;
            font-family: 'Comic Neue';
            z-index: 1100;
            text-decoration: none;
            animation: pulse 2s infinite;
            border: none;
        }
        #youtubeBtn { left: 20px; background: linear-gradient(45deg, #ff4757, #ff6348); color: white; }
        #aboutBtn { right: 20px; background: linear-gradient(45deg, #4CAF50, #8BC34A); color: white; animation: none; }
        .ui-info-text {
            position: fixed; left: 10px; top: 10px; z-index: 500;
            font-family: 'Comic Neue'; text-align: left; font-weight: bold;
            text-shadow: 2px 2px 6px rgba(255, 255, 255, 0.7);
        }
        #endMessage, #rulesMessage {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(74,21,75,0.95); color: white; padding: 25px;
            border-radius: 15px; z-index: 10000; font-size: 1.2em;
            text-align: center; font-family: 'Comic Neue';
            box-shadow: 0 10px 30px rgba(0,0,0,0.6); display: none;
            max-width: 80%;
        }
        #rulesMessage {
            background: linear-gradient(135deg, #4A00E0, #8E2DE2);
            font-size: 1.1em;
            border: 3px solid #FFD700;
        }
        #rulesMessage button {
            margin-top: 20px; padding: 10px 20px; border: none; border-radius: 20px;
            background: #FFD700; color: #4A00E0; font-weight: bold; cursor: pointer;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        @media (max-height: 700px) {
            #startGame1Btn { bottom: 160px; }
            #startGame2Btn { bottom: 100px; }
            #rulesBtn { bottom: 220px; }
            #soundBtn { bottom: 280px; }
        }
    </style>
</head>
<body>
    <div class="arjs-loader" id="loader">
        <div class="pulse">ü¶∑ –õ–∞—Å–∫–∞–≤–æ –ø—Ä–æ—Å–∏–º–æ –¥–æ "Nikadent-Family"!</div>
        <div style="margin-top: 20px; font-size: 1.1em; font-weight: bold; color: #ff0000;">
            ‚ùó –£–≤–∞–≥–∞: –ù–∞–≤–µ–¥–∏ –∫–∞–º–µ—Ä—É –Ω–∞ –≤—ñ–∑–∏—Ç—ñ–≤–∫—É, —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ –∑—É–±—á–∏–∫ —ñ –ø–æ—á–∞—Ç–∏ –≥—Ä—É!
        </div>
        <div style="margin-top: 10px; font-size: 0.9em;">
            –ü–æ—Å—Ç—É–∫–∞–π, –ø–æ–∫—Ä—É—Ç–∏ —Ç–∞ –ø–æ–º–∞—Å—à—Ç–∞–±—É–π –∑—É–±—á–∏–∫! üòä
        </div>
    </div>

    <p id="timerText" class="ui-info-text">‚è≥ –ß–∞—Å: 00</p>
    <p id="scoreText" class="ui-info-text">üåü –ë–∞–ª—ñ–≤: 0</p>

    <div id="rulesMessage">
        <h3>üí° –ü—Ä–∞–≤–∏–ª–∞ –ì—Ä–∏ "–ó–¥–æ—Ä–æ–≤–∞ –£—Å–º—ñ—à–∫–∞"!</h3>
        <p><strong>–ï—Ç–∞–ø 1: "–ó–¥–æ—Ä–æ–≤–∏–π –í–∏–±—ñ—Ä" (60 —Å–µ–∫)</strong></p>
        <ul>
            <li>‚úÖ **–ö–ª—ñ–∫–∞–π** —Ç—ñ–ª—å–∫–∏ –Ω–∞ **–∫–æ—Ä–∏—Å–Ω—É** —ó–∂—É —Ç–∞ –ø—Ä–µ–¥–º–µ—Ç–∏ (üçé, ü¶∑, ü™•). –û—Ç—Ä–∏–º–∞—î—à **+10 –±–∞–ª—ñ–≤**.</li>
            <li>‚ùå **–ù–ï –ö–õ–Ü–ö–ê–ô** –Ω–∞ —à–∫—ñ–¥–ª–∏–≤—É —ó–∂—É (üçî, üçü, üç≠). –í—Ç—Ä–∞—Ç–∏—à **-5 –±–∞–ª—ñ–≤**.</li>
        </ul>
        <hr style="border-color: #FFD700;">
        <p><strong>–ï—Ç–∞–ø 2: "–ß–∏—Å—Ç–∫–∞ –ó—É–±—ñ–≤" (20 —Å–µ–∫)</strong></p>
        <ul>
            <li>üßπ –®–≤–∏–¥–∫–æ **–≤–∏—Ç–∏—Ä–∞–π –ø–∞–ª—å—Ü–µ–º (–∞–±–æ –∫–ª—ñ–∫–æ–º)** –≤—Å—ñ –∂–æ–≤—Ç—ñ –ø–ª—è–º–∏ –∑ –≤–µ–ª–∏–∫–æ–≥–æ –∑—É–±—á–∏–∫–∞. –ö–æ–∂–Ω–∞ –ø–ª—è–º–∞ **+10 –±–∞–ª—ñ–≤**!</li>
        </ul>
        <p>üëâ **–ü–∞—É–∑–∞:** –î–≤—ñ—á—ñ —à–≤–∏–¥–∫–æ —Ç–æ—Ä–∫–Ω–∏—Å—å –µ–∫—Ä–∞–Ω–∞ (–ø–æ–¥–≤—ñ–π–Ω–∏–π —Ç–∞–ø).</p>
        <button id="closeRulesBtn">–ó—Ä–æ–∑—É–º—ñ–ª–æ! –ü–æ—á–∏–Ω–∞—î–º–æ!</button>
    </div>

    <div id="endMessage"></div>

    <div id="canvasGameContainer" style="display: none;">
        <canvas id="gameCanvas"></canvas>
        <button id="endBtn" class="ui-btn" style="bottom: 40px; display: block;">üõë –ü–µ—Ä–µ—Ö—ñ–¥ –¥–æ —á–∏—Å—Ç–∫–∏</button>
    </div>

    <div id="cleaningGameContainer" style="display: none;">
        <canvas id="cleaningCanvas"></canvas>
        <button id="cleaningEndBtn" class="ui-btn" style="bottom: 40px; display: block;">‚úÖ –ì–æ—Ç–æ–≤–æ!</button>
    </div>

    <a-scene
        mindar-image="imageTargetSrc: my-marker.mind;"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false"
        loading-screen="enabled: false"
        embedded
        renderer="colorManagement: true; physicallyCorrectLights: true;"
        touch-gestures="targetId: tooth-model; initialScale: 0.3;" >
        <a-assets>
            <a-asset-item id="toothModel" src="assets/3d_models/a-gltf-model.glb"></a-asset-item>
            <audio id="bg-music" src="assets/audio/sound4.mp3" preload="auto" muted playsinline crossorigin="anonymous"></audio>
            <audio id="applauseSound" src="assets/audio/applause.mp3" preload="auto" muted playsinline crossorigin="anonymous"></audio>
            <audio id="toothClickSound" src="assets/audio/sound5.mp3" preload="auto" muted playsinline crossorigin="anonymous"></audio>
        </a-assets>

        <a-camera
            look-controls="enabled: false"
            position="0 0 0"
        >
             <a-cursor
                raycaster="objects: .clickable;" 
                cursor="fuse: false; maxDistance: 10"
                position="0 0 -1"
                geometry="primitive: ring; radiusOuter: 0.015; radiusInner: 0.008"
                material="color: #FFD700; shader: flat"
            ></a-cursor>
        </a-camera>

        <a-entity mindar-image-target="targetIndex: 0">
            <a-gltf-model
                id="tooth-model"
                class="clickable"
                src="#toothModel"
                scale="0.3 0.3 0.3"
                position="0 0 0.1"
                rotation="0 0 0"
                shadow
                animation-mixer="clip: Idle; loop: repeat; timeScale: 1.0; autoplay: true;">
            </a-gltf-model>
        </a-entity>
    </a-scene>

    <button id="startGame1Btn" class="ui-btn">üöÄ –ì—Ä–∞ 1: –ó–¥–æ—Ä–æ–≤–∏–π –í–∏–±—ñ—Ä</button>
    <button id="startGame2Btn" class="ui-btn">üßº –ì—Ä–∞ 2: –ß–∏—Å—Ç–∫–∞ –ó—É–±—ñ–≤</button>
    <button id="stopBtn" class="ui-btn" style="display: none;">‚è∏ –ü–∞—É–∑–∞</button>
    <button id="rulesBtn" class="ui-btn">‚ùì –ü—Ä–∞–≤–∏–ª–∞ –ì—Ä–∏</button>
    <button id="soundBtn" class="ui-btn">üîä –£–≤—ñ–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫</button>
    <a href="https://www.youtube.com/@23smartlessa32?si=d3NhKDot8U8Mc2Hi" id="youtubeBtn" class="corner-btn" target="_blank" rel="noopener noreferrer">‚ù§Ô∏è –ê–≤—Ç–æ—Ä</a>
    <a href="https://nikadent-family.com.ua/ua/" id="aboutBtn" class="corner-btn" target="_blank" rel="noopener noreferrer">‚ÑπÔ∏è –ü—Ä–æ –Ω–∞—Å</a>

    <script>
        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∑–º—ñ–Ω–Ω–∏—Ö (—á–∞—Å—Ç–∏–Ω–∞ 1)
        function fixHeight() { document.body.style.height = window.innerHeight + 'px'; }
        fixHeight();
        window.addEventListener('resize', fixHeight);

        const loader = document.querySelector('#loader');
        const targetEntity = document.querySelector('a-entity[mindar-image-target]');
        const toothModel = document.querySelector('#tooth-model');
        const startGame1Btn = document.querySelector('#startGame1Btn');
        const startGame2Btn = document.querySelector('#startGame2Btn');
        const stopBtn = document.querySelector('#stopBtn');
        const rulesBtn = document.querySelector('#rulesBtn');
        const soundBtn = document.querySelector('#soundBtn');
        const youtubeBtn = document.querySelector('#youtubeBtn');
        const aboutBtn = document.querySelector('#aboutBtn');
        const timerText = document.getElementById('timerText');
        const scoreText = document.getElementById('scoreText');
        const bgMusic = document.querySelector('#bg-music');
        const applauseSound = document.querySelector('#applauseSound');
        const toothClickSound = document.querySelector('#toothClickSound');
        const endMessage = document.getElementById('endMessage');
        const rulesMessage = document.getElementById('rulesMessage');
        const closeRulesBtn = document.getElementById('closeRulesBtn');
        const endBtn = document.getElementById('endBtn');
        const cleaningEndBtn = document.getElementById('cleaningEndBtn');

        let isGameRunning = false;
        let isPaused = false;
        let score = 0;
        let emojis = [];
        let startTime = null;
        let inputHandler = null;
        let lastTap = 0;
        let currentGame = null;

        soundBtn.textContent = bgMusic.muted ? "üîä –£–≤—ñ–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫" : "üîá –í–∏–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫";
        
        // =========================================================
        // === 1. –ö–û–ú–ü–û–ù–ï–ù–¢ –î–õ–Ø –û–ë–†–û–ë–ö–ò –ñ–ï–°–¢–Ü–í (–û–ë–ï–†–¢–ê–ù–ù–Ø/–ú–ê–°–®–¢–ê–ë) ===
        // =========================================================

        AFRAME.registerComponent('touch-gestures', {
            schema: {
                targetId: { type: 'string', default: '' }, // ID –º–æ–¥–µ–ª—ñ, —è–∫–æ—é –∫–µ—Ä—É—î–º–æ
                initialScale: { type: 'number', default: 1.0 },
                minScale: { type: 'number', default: 0.15 },
                maxScale: { type: 'number', default: 1.0 },
                rotationSpeed: { type: 'number', default: 0.5 } // –ó–º–µ–Ω—à–µ–Ω–æ —à–≤–∏–¥–∫—ñ—Å—Ç—å –æ–±–µ—Ä—Ç–∞–Ω–Ω—è
            },
            init: function () {
                this.isRotating = false;
                this.isPinching = false;
                this.startPos = { x: 0, y: 0 };
                this.initialDistance = 0;
                this.currentScale = this.data.initialScale;
                this.targetEl = document.querySelector(`#${this.data.targetId}`);
                
                if (!this.targetEl) {
                    console.error('–¶—ñ–ª—å–æ–≤–∏–π –µ–ª–µ–º–µ–Ω—Ç –¥–ª—è –∂–µ—Å—Ç—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!');
                    return;
                }
                
                // –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–æ—á–∞—Ç–∫–æ–≤–æ–≥–æ –º–∞—Å—à—Ç–∞–±—É
                const initial = this.data.initialScale;
                this.targetEl.object3D.scale.set(initial, initial, initial);
                
                this.el.addEventListener('touchstart', (e) => {
                    if (isGameRunning) return; // –í–∏–º–∏–∫–∞—î–º–æ –º–∞–Ω—ñ–ø—É–ª—è—Ü—ñ—ó –ø—ñ–¥ —á–∞—Å –≥—Ä–∏

                    e.preventDefault();
                    if (e.touches.length === 1) {
                        this.isRotating = true;
                        this.startPos.x = e.touches[0].pageX;
                        this.startPos.y = e.touches[0].pageY;
                    } else if (e.touches.length === 2) {
                        this.isPinching = true;
                        this.isRotating = false;
                        this.initialDistance = Math.hypot(
                            e.touches[0].pageX - e.touches[1].pageX,
                            e.touches[0].pageY - e.touches[1].pageY
                        );
                        this.currentScale = this.targetEl.object3D.scale.x;
                    }
                });

                this.el.addEventListener('touchmove', (e) => {
                    if (isGameRunning) return; 

                    e.preventDefault();
                    if (this.isPinching && e.touches.length === 2) {
                        const currentDistance = Math.hypot(
                            e.touches[0].pageX - e.touches[1].pageX,
                            e.touches[0].pageY - e.touches[1].pageY
                        );
                        const scaleFactor = currentDistance / this.initialDistance;
                        let newScale = this.currentScale * scaleFactor;
                        
                        // –û–±–º–µ–∂–µ–Ω–Ω—è –º–∞—Å—à—Ç–∞–±—É
                        newScale = Math.max(this.data.minScale, Math.min(this.data.maxScale, newScale));
                        
                        this.targetEl.object3D.scale.set(newScale, newScale, newScale);
                    } else if (this.isRotating && e.touches.length === 1) {
                        const deltaX = (e.touches[0].pageX - this.startPos.x) * this.data.rotationSpeed;
                        const deltaY = (e.touches[0].pageY - this.startPos.y) * this.data.rotationSpeed;
                        
                        // –û–±–µ—Ä—Ç–∞–Ω–Ω—è
                        this.targetEl.object3D.rotation.y += THREE.MathUtils.degToRad(deltaX);
                        this.targetEl.object3D.rotation.x += THREE.MathUtils.degToRad(deltaY);
                        
                        this.startPos.x = e.touches[0].pageX;
                        this.startPos.y = e.touches[0].pageY;
                    }
                });

                this.el.addEventListener('touchend', () => {
                    this.isRotating = false;
                    this.isPinching = false;
                });
            }
        });
        
        // =========================================================
        // === 2. –û–°–ù–û–í–ù–ê –õ–û–ì–Ü–ö–ê –ü–†–û–Ñ–ö–¢–£ (–ó–ê–õ–ò–®–ï–ù–û –§–£–ù–ö–¶–Ü–û–ù–ê–õ) ===
        // =========================================================
        
        // === –í–∑–∞—î–º–æ–¥—ñ—è –∑ –∑—É–±—á–∏–∫–æ–º (–∫–ª—ñ–∫) ===
        toothModel.addEventListener('click', () => {
            if (!isGameRunning && rulesMessage.style.display !== 'block') {
                if (toothClickSound && !toothClickSound.muted) {
                    toothClickSound.currentTime = 0;
                    toothClickSound.play().catch(e => console.log("üîá –ó–≤—É–∫ –Ω–µ –∑–∞–ø—É—Å—Ç–∏–≤—Å—è:", e));
                }
                // –ê–Ω—ñ–º–∞—Ü—ñ—è –ø—É–ª—å—Å–∞—Ü—ñ—ó
                toothModel.setAttribute('animation__pulse', {
                    property: 'scale', 
                    to: `${toothModel.object3D.scale.x * 1.2} ${toothModel.object3D.scale.y * 1.2} ${toothModel.object3D.scale.z * 1.2}`, 
                    dur: 200, dir: 'alternate', loop: 2
                });
                
                endMessage.textContent = "ü¶∑ –ü—Ä–∏–≤—ñ—Ç! –Ø ‚Äî –∑—É–±—á–∏–∫! –ü–æ—á–Ω–∏ –≥—Ä—É, —â–æ–± –≤—Ä—è—Ç—É–≤–∞—Ç–∏ –º–µ–Ω–µ!";
                endMessage.style.display = 'block';
                setTimeout(() => { endMessage.style.display = 'none'; }, 3000);
            }
        });

        // === –ü–æ–¥—ñ—ó –º–∞—Ä–∫–µ—Ä–∞: –ü–æ–∫–∞–∑–∞—Ç–∏/–°—Ö–æ–≤–∞—Ç–∏ UI ===
        function updateUIOnTarget() {
             const isTargetVisible = targetEntity.object3D.visible;
             if (isTargetVisible) {
                loader.style.display = 'none';
                if (!isGameRunning) {
                    startGame1Btn.style.display = 'block';
                    startGame2Btn.style.display = 'block';
                    rulesBtn.style.display = 'block';
                    soundBtn.style.display = 'block';
                }
                youtubeBtn.style.display = 'block';
                aboutBtn.style.display = 'block';
                
                if (isGameRunning) {
                    stopBtn.style.display = 'block';
                    timerText.style.display = 'block';
                    scoreText.style.display = 'block';
                }
            } else {
                 if (!isGameRunning) {
                    startGame1Btn.style.display = 'none';
                    startGame2Btn.style.display = 'none';
                    rulesBtn.style.display = 'none';
                    soundBtn.style.display = 'none';
                    stopBtn.style.display = 'none';
                }
                youtubeBtn.style.display = 'none';
                aboutBtn.style.display = 'none';
                timerText.style.display = 'none';
                scoreText.style.display = 'none';
            }
        }
        
        targetEntity.addEventListener('targetFound', updateUIOnTarget);
        targetEntity.addEventListener('targetLost', updateUIOnTarget);
        setInterval(updateUIOnTarget, 500);


        // === –ö–µ—Ä—É–≤–∞–Ω–Ω—è –∑–≤—É–∫–æ–º ===
        function toggleSound() {
            bgMusic.muted = !bgMusic.muted;
            applauseSound.muted = !bgMusic.muted;
            toothClickSound.muted = !bgMusic.muted;
            soundBtn.textContent = bgMusic.muted ? "üîä –£–≤—ñ–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫" : "üîá –í–∏–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫";
            if (!bgMusic.muted && isGameRunning) {
                bgMusic.play().catch(e => console.log("üîá –ú—É–∑–∏–∫–∞ –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª–∞—Å—è:", e));
            } else if (bgMusic.muted) {
                bgMusic.pause();
            }
        }
        soundBtn.addEventListener('click', toggleSound);

        // === –ü–∞—É–∑–∞ —á–µ—Ä–µ–∑ –ø–æ–¥–≤—ñ–π–Ω–∏–π —Ç–∞–ø (–ó–∞–ª–∏—à–∞—î—Ç—å—Å—è —è–∫ —É –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–º—É –∫–æ–¥—ñ) ===
        function handleDoubleTap(e) {
            if (!isGameRunning || rulesMessage.style.display === 'block') return;
            const now = Date.now();
            if (now - lastTap < 300) {
                if (isPaused) {
                    isPaused = false;
                    stopBtn.textContent = "‚è∏ –ü–∞—É–∑–∞";
                    endMessage.style.display = 'none';
                    if (!bgMusic.muted) bgMusic.play().catch(e => console.log("üîá –ú—É–∑–∏–∫–∞:", e));
                    if (currentGame === 'game1') requestAnimationFrame(animateGame1);
                    else if (currentGame === 'game2') requestAnimationFrame(animateGame2);
                } else {
                    isPaused = true;
                    stopBtn.textContent = "‚ñ∂Ô∏è –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏";
                    bgMusic.pause();
                    endMessage.textContent = "‚è∏ –ü–∞—É–∑–∞. –ü–æ–¥–≤—ñ–π–Ω–∏–π —Ç–∞–ø –¥–ª—è –ø—Ä–æ–¥–æ–≤–∂–µ–Ω–Ω—è!";
                    endMessage.style.display = 'block';
                }
            }
            lastTap = now;
        }
        document.addEventListener('touchstart', handleDoubleTap, { passive: false });
        document.addEventListener('click', (e) => {
             // –í–∏–∫–ª—é—á–∞—î–º–æ –∫–ª—ñ–∫ –ø–æ –∫–Ω–æ–ø–∫–∞—Ö
            if (e.target.tagName !== 'BUTTON' && e.target.tagName !== 'A' && e.target.closest('#rulesMessage') === null) {
                handleDoubleTap(e);
            }
        });

        // === –§—É–Ω–∫—Ü—ñ—è –∑—É–ø–∏–Ω–∫–∏/—Å–∫–∏–¥–∞–Ω–Ω—è –≥—Ä–∏ ===
        function stopGame() {
            isGameRunning = false;
            isPaused = false;
            stopBtn.style.display = 'none';
            
            document.getElementById('canvasGameContainer').style.display = 'none';
            document.getElementById('cleaningGameContainer').style.display = 'none';
            document.querySelector('a-scene').style.display = 'block';
            
            timerText.style.display = 'none';
            scoreText.style.display = 'none';
            if (endMessage) endMessage.style.display = 'none';
            
            bgMusic.pause();
            
            startGame1Btn.style.display = 'block';
            startGame2Btn.style.display = 'block';
            rulesBtn.style.display = 'block';
            soundBtn.style.display = 'block';
        }

        function resetGame() {
            stopGame();
            score = 0;
            emojis = [];
            startTime = null;
            scoreText.textContent = `üåü –ë–∞–ª—ñ–≤: 0`;
            timerText.textContent = `‚è≥ –ß–∞—Å: 60`;
        }
        
        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–æ–∫–∞–∑—É –ø—Ä–∞–≤–∏–ª –ø–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º
        function showRulesBeforeStart(gameType) {
            currentGame = gameType;
            startGame1Btn.style.display = 'none';
            startGame2Btn.style.display = 'none';
            rulesBtn.style.display = 'none';
            soundBtn.style.display = 'none';
            youtubeBtn.style.display = 'none';
            aboutBtn.style.display = 'none';
            document.querySelector('a-scene').style.display = 'none';
            rulesMessage.style.display = 'block';
        }

        // === –ö–ù–û–ü–ö–ò –°–¢–ê–†–¢–£ –ì–†–ò ===
        startGame1Btn.addEventListener('click', () => showRulesBeforeStart('game1'));
        startGame2Btn.addEventListener('click', () => showRulesBeforeStart('game2'));

        closeRulesBtn.addEventListener('click', () => {
            rulesMessage.style.display = 'none';
            if (currentGame === 'game1') startCanvasGame(60);
            else if (currentGame === 'game2') startCanvasGame(0);
        });

        stopBtn.addEventListener('click', () => {
            if (isPaused) {
                handleDoubleTap({ timeStamp: Date.now() + 300 });
            } else {
                isPaused = true;
                stopBtn.textContent = "‚ñ∂Ô∏è –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏";
                bgMusic.pause();
                endMessage.textContent = "‚è∏ –ü–∞—É–∑–∞";
                endMessage.style.display = 'block';
                setTimeout(() => endMessage.style.display = 'none', 2000);
            }
        });
        
        rulesBtn.addEventListener('click', () => { rulesMessage.style.display = 'block'; });

        // === –§—É–Ω–∫—Ü—ñ—ó Canvas-–Ü–≥–æ—Ä (–∑–∞–≥–ª—É—à–∫–∏) ===
        // –£–í–ê–ì–ê: –î–ª—è –ø–æ–≤–Ω–æ—ó —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—ñ —Ç—É—Ç –º–∞—é—Ç—å –±—É—Ç–∏ –≤—Å—ñ –¥–µ—Ç–∞–ª—ñ Game1 —ñ Game2
        // –Ø –∑–∞–ª–∏—à–∞—é —Ç—É—Ç —Å–ø—Ä–æ—â–µ–Ω—É –ª–æ–≥—ñ–∫—É –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü—ñ—ó, —è–∫ –ø—Ä–∞—Ü—é—î –ø–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è

        function startCanvasGame(initialTime) {
            isGameRunning = true;
            isPaused = false;
            stopBtn.textContent = "‚è∏ –ü–∞—É–∑–∞";
            stopBtn.style.display = 'block';
            
            if (initialTime > 0) {
                 document.getElementById('canvasGameContainer').style.display = 'block';
                 initCanvasGame(initialTime);
            } else {
                 document.getElementById('cleaningGameContainer').style.display = 'block';
                 initCleaningGame();
            }
        }
        
        function initCanvasGame(duration) {
             const canvas = document.getElementById('gameCanvas');
             // –¢—É—Ç –º–∞—î –±—É—Ç–∏ –ø–æ–≤–Ω–∞ –ª–æ–≥—ñ–∫–∞ initCanvasGame –∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ—ó –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ...
             
             startTime = Date.now();
             score = 0; // –°–∫–∏–¥–∞—î–º–æ —Ä–∞—Ö—É–Ω–æ–∫ –¥–ª—è —á–∏—Å—Ç–æ–≥–æ —Å—Ç–∞—Ä—Ç—É Game 1
             timerText.textContent = `‚è≥ –ß–∞—Å: ${duration}`;
             scoreText.textContent = `üåü –ë–∞–ª—ñ–≤: 0`;
             timerText.style.display = 'block';
             scoreText.style.display = 'block';
             
             function endCanvasGame() {
                 document.getElementById('canvasGameContainer').style.display = 'none';
                 document.getElementById('cleaningGameContainer').style.display = 'block';
                 initCleaningGame();
             }
             
             // –Ü–º—ñ—Ç–∞—Ü—ñ—è —Ç–∞–π–º–µ—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è
             if (duration > 0) setTimeout(endCanvasGame, duration * 1000); 
             
             document.getElementById('endBtn').onclick = endCanvasGame;
             // –í —Ü—å–æ–º—É –º—ñ—Å—Ü—ñ –º–∞—î –±—É—Ç–∏ requestAnimationFrame(animateGame1)
        }

        function initCleaningGame() {
            currentGame = 'game2';
            const canvas = document.getElementById('cleaningCanvas');
            // –¢—É—Ç –º–∞—î –±—É—Ç–∏ –ø–æ–≤–Ω–∞ –ª–æ–≥—ñ–∫–∞ initCleaningGame –∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ—ó –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ...
            
            // –°–∫–∏–¥–∞—î–º–æ —Ç–∞–π–º–µ—Ä —ñ –¥–æ–¥–∞—î–º–æ –ø–æ—á–∞—Ç–∫–æ–≤—ñ –±–∞–ª–∏ Game 1, —è–∫—â–æ –±—É–ª–∞ Game 1
            if (currentGame === 'game2') timerText.textContent = `‚è≥ –ß–∞—Å: 20`; 
            
            document.getElementById('cleaningEndBtn').onclick = () => {
                endMessage.textContent = `üéâ –ì—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –ó–∞–≥–∞–ª—å–Ω–∏–π —Ä–∞—Ö—É–Ω–æ–∫: ${score} –±–∞–ª—ñ–≤!`;
                endMessage.style.display = 'block';
                setTimeout(() => { endMessage.style.display = 'none'; stopGame(); }, 5000);
            };
            // –í —Ü—å–æ–º—É –º—ñ—Å—Ü—ñ –º–∞—î –±—É—Ç–∏ requestAnimationFrame(animateGame2)
        }
    </script>
</body>
</html>
