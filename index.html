<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ü¶∑ –ó—É–±—á–∏–∫-–í–µ—Å–µ–ª—É–Ω—á–∏–∫</title>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* –ë–∞–∑–æ–≤—ñ —Å—Ç–∏–ª—ñ */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'Comic Neue', 'Comic Sans MS', cursive, sans-serif;
            background: transparent;
            touch-action: none;
        }
        
        a-scene {
            width: 100vw !important;
            height: 100vh !important;
            position: fixed;
            top: 0;
            left: 0;
            background: transparent;
            transition: opacity 0.3s ease;
        }

        /* –°—Ç–∏–ª—ñ –¥–ª—è –µ–∫—Ä–∞–Ω—ñ–≤ —Å—Ç–∞–Ω—ñ–≤ */
        .state-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            padding: 20px;
            box-sizing: border-box;
            text-align: center;
        }

        .backdrop-blur {
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            background: rgba(255, 255, 255, 0.1);
        }

        .smooth-transition {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* –ï–∫—Ä–∞–Ω –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è */
        .arjs-loader {
            background: linear-gradient(135deg, #E0F7FA, #B2EBF2);
            color: #00796B;
            font-size: clamp(1.2em, 5vw, 1.5em);
            font-family: 'Comic Neue', sans-serif;
        }

        /* –ï–∫—Ä–∞–Ω –ø–æ–º–∏–ª–æ–∫ */
        .error-screen {
            background: linear-gradient(135deg, #FFE0E0, #FFB2B2);
            color: #D32F2F;
        }

        .error-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-width: 90%;
            width: 400px;
        }

        .error-content details {
            margin: 15px 0;
            text-align: left;
        }

        .error-content summary {
            cursor: pointer;
            font-weight: bold;
        }

        /* –ï–∫—Ä–∞–Ω –ø–µ—Ä–µ–º–æ–≥–∏ */
        .victory-screen {
            background: linear-gradient(135deg, #E8F5E9, #C8E6C9);
            color: #388E3C;
        }

        .victory-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-width: 90%;
            width: 400px;
        }

        .score-display {
            font-size: 2em;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin: 10px 0;
        }

        /* –ê–Ω—ñ–º–∞—Ü—ñ—ó */
        .pulse-glow {
            animation: pulse-glow 2s ease-in-out infinite alternate;
        }

        @keyframes pulse-glow {
            from {
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
                transform: scale(1);
            }
            to {
                box-shadow: 0 0 30px rgba(255, 215, 0, 0.8), 0 0 40px rgba(255, 215, 0, 0.4);
                transform: scale(1.05);
            }
        }

        .floating-animation {
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(2deg); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* UI –∫–Ω–æ–ø–∫–∏ */
        .ui-btn {
            position: fixed;
            padding: clamp(12px, 3vw, 15px) clamp(20px, 5vw, 25px);
            border-radius: 20px;
            font-size: clamp(1em, 4vw, 1.2em);
            font-weight: bold;
            z-index: 1000;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            cursor: pointer;
            border: 3px solid white;
            display: none;
            font-family: 'Comic Neue', sans-serif;
            text-align: center;
            width: clamp(40%, 45vw, 45%);
            max-width: 250px;
            animation: pulse 2s infinite;
        }

        .ui-btn:hover, .ui-btn:active {
            transform: scale(1.05);
        }

        /* –°–ø–µ—Ü–∏—Ñ—ñ—á–Ω—ñ –∫–Ω–æ–ø–∫–∏ */
        #mainPlayBtn {
            bottom: clamp(140px, 20vh, 150px);
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
            color: white;
            width: clamp(50%, 55vw, 300px);
            max-width: 300px;
        }

        #startGame1Btn { 
            bottom: clamp(160px, 22vh, 170px); 
            left: 10%; 
            background: linear-gradient(40deg, #FF6B6B, #FF8E53); 
            color: white; 
        }

        #startGame2Btn { 
            bottom: clamp(160px, 22vh, 170px); 
            right: 5%;
            background: linear-gradient(40deg, #87CEFA, #4682B4); 
            color: white; 
        }

        #startGame3Btn { 
            bottom: clamp(80px, 7vh, 80px);
            left: 25%;
            transform: translateX(-50%);
            background: linear-gradient(40deg, #FFD700, #FFA500); 
            color: #4A00E0; 
            border: 3px solid #4A00E0;
        }

        #rulesBtn { 
            bottom: clamp(20px, 4vh, 20px); 
            left: 20%;
            transform: translateX(-50%);
            background: linear-gradient(40deg, #BA68C8, #AB47BC); 
            color: white; 
        }

        #soundBtn { 
            top: clamp(15px, 3vh, 20px); 
            left: clamp(15px, 3vw, 20px); 
            background: linear-gradient(40deg, #00CED1, #20B2AA); 
            color: white; 
        }

        #resetRotationBtn {
            top: clamp(15px, 3vh, 20px);
            right: clamp(15px, 3vw, 20px);
            background: linear-gradient(45deg, #9B59B6, #8E44AD);
            color: white;
        }

        #returnBtn {
            bottom: clamp(15px, 3vh, 20px);
            right: clamp(15px, 3vw, 20px);
            padding: clamp(10px, 2.5vw, 12px) clamp(15px, 4vw, 20px);
            font-size: clamp(0.9em, 3.5vw, 1em);
            background: linear-gradient(45deg, #ff4757, #ff6b81);
            color: white;
            width: auto;
            max-width: 250px;
        }

        /* –Ü–Ω—à—ñ –µ–ª–µ–º–µ–Ω—Ç–∏ UI */
        .ui-info-text {
            position: fixed;
            left: clamp(8px, 2vw, 10px);
            top: clamp(8px, 2vh, 10px);
            z-index: 500;
            font-family: 'Comic Neue';
            text-align: left;
            font-weight: bold;
            text-shadow: 2px 2px 6px rgba(255, 255, 255, 0.7);
            color: #00796B;
            font-size: clamp(1.3em, 4.5vw, 1.5em);
            background: rgba(255, 255, 255, 0.7);
            padding: 8px 15px;
            border-radius: 15px;
            display: none;
        }

        #scoreText { top: clamp(50px, 10vh, 60px); }

        #fps-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 10px;
            font-family: monospace;
            z-index: 10000;
            font-size: 12px;
        }

        /* –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è */
        #endMessage, #rulesMessage, #listenMessage {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #4DB6AC, #00796B);
            color: white;
            padding: clamp(15px, 4vw, 20px);
            border-radius: 20px;
            z-index: 10000;
            font-size: clamp(1.2em, 5vw, 1.6em);
            text-align: center;
            font-family: 'Comic Neue';
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
            display: none;
            max-width: none;
            width: 95vw;
            padding: 25px 30px;
            border: 3px solid #FFD700;
        }

        /* Canvas –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏ */
        #gameCanvas, #cleaningCanvas, #cariesCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 50;
            background: linear-gradient(135deg, #E0F7FA, #B2EBF2);
            display: none;
        }

        #brush {
            position: fixed;
            width: clamp(80px, 20vw, 100px);
            height: clamp(80px, 20vw, 100px);
            font-size: clamp(70px, 18vw, 90px);
            text-align: center;
            line-height: clamp(80px, 20vw, 100px);
            pointer-events: none;
            z-index: 100;
            display: none;
            text-shadow: 0 0 10px rgba(0,0,0,0.5);
            filter: drop-shadow(0 0 5px rgba(0,0,0,0.3));
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ñ—Å—Ç—å */
        @media (max-width: 768px) {
            .ui-btn {
                padding: 14px 20px;
                font-size: 16px;
                margin: 8px;
            }
            
            .game-canvas {
                touch-action: none;
            }
        }

        @media (max-height: 600px) {
            #startGame1Btn, #startGame2Btn {
                bottom: clamp(120px, 25vh, 140px);
            }
            
            #startGame3Btn {
                bottom: clamp(60px, 10vh, 70px);
            }
        }
    </style>
</head>
<body>
    <!-- –ï–∫—Ä–∞–Ω–∏ —Å—Ç–∞–Ω—ñ–≤ -->
    <div class="arjs-loader state-screen" id="loader">
        <div class="pulse floating-animation">ü¶∑ –ó–Ω–∞–π–¥–∏ –∫–∞—Ä—Ç–∫—É –ó—É–±—á–∏–∫–∞!</div>
        <div style="margin-top: clamp(10px, 2vh, 15px); font-size: clamp(1em, 4vw, 1.2em); font-weight: bold; color: #00796B;">
            ‚ùó –ù–∞–≤–µ–¥–∏ –∫–∞–º–µ—Ä—É –Ω–∞ –∫–∞—Ä—Ç–∫—É!
        </div>
        <div style="margin-top: clamp(5px, 1vh, 8px); font-size: clamp(0.8em, 3vw, 1em);">
            –ü–æ–∫—Ä—É—Ç–∏ –∑—É–±—á–∏–∫–∞ –ø–∞–ª—å—á–∏–∫–æ–º! üòä
        </div>
    </div>

    <!-- FPS —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä -->
    <div id="fps-indicator" style="display: none;">FPS: 60</div>

    <!-- UI –µ–ª–µ–º–µ–Ω—Ç–∏ -->
    <p id="timerText" class="ui-info-text">‚è≥ –ß–∞—Å: 00</p>
    <p id="scoreText" class="ui-info-text">üåü –ë–∞–ª–∏: 0</p>

    <!-- –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è -->
    <div id="rulesMessage">
        <h3>üéÆ –Ø–∫ –≥—Ä–∞—Ç–∏ –∑ –ó—É–±—á–∏–∫–æ–º?</h3>
        <ul>
            <li><strong>–ì—Ä–∞ "–ó–¥–æ—Ä–æ–≤–∞ –á–∂–∞"</strong>: –õ–æ–≤–∏ üçé, ü•ï, ü¶∑! –û—Ç—Ä–∏–º—É–π +10! üçî, üç≠, üç´ —É–Ω–∏–∫–∞–π!</li>
            <li><strong>–ì—Ä–∞ "–ß–∏—Å—Ç–∫–∞ –ó—É–±—ñ–≤"</strong>: –ß–∏—Å—Ç–∏ ü¶∑ —â—ñ—Ç–∫–æ—é! –ö–æ–∂–Ω–∞ –ø–ª—è–º–∞ = +10!</li>
            <li><strong>–ì—Ä–∞ "–ó–Ω–∞–π–¥–∏ –ö–∞—Ä–∏—î—Å"</strong>: –ù–∞—Ç–∏—Å–∫–∞–π —É —Ç–µ–º–Ω—ñ –ø–ª—è–º–∫–∏! –ö–æ–∂–Ω–∞ –∑–Ω–∞—Ö—ñ–¥–∫–∞ = +15!</li>
        </ul>
        <button id="closeRulesBtn">–ì—Ä–∞—Ç–∏! üöÄ</button>
    </div>

    <div id="endMessage"></div>
    <div id="listenMessage">
        <p>ü¶∑ –ü—Ä–∏–≤—ñ—Ç, –¥—Ä—É–∂–µ! –Ø - –ó—É–±—á–∏–∫-–í–µ—Å–µ–ª—É–Ω—á–∏–∫! üòä</p>
        <p>–•–æ—á–µ—à –ø–æ—Å–ª—É—Ö–∞—Ç–∏ –º–æ—é –ø—ñ—Å–µ–Ω—å–∫—É?</p>
        <button id="listenBtn">–ü–æ—Å–ª—É—Ö–∞—Ç–∏ üé∂</button>
    </div>

    <!-- –Ü–≥—Ä–æ–≤—ñ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏ -->
    <div id="canvasGameContainer">
        <canvas id="gameCanvas"></canvas>
        <button id="endBtn" class="ui-btn">‚ñ∂Ô∏è –ß–∏—Å—Ç–∏ –∑—É–±—á–∏–∫!</button>
    </div>

    <div id="cleaningGameContainer">
        <canvas id="cleaningCanvas"></canvas>
        <div id="brush">ü™•</div> 
        <button id="cleaningEndBtn" class="ui-btn">‚úÖ –ì–æ—Ç–æ–≤–æ!</button>
    </div>

    <div id="cariesGameContainer">
        <canvas id="cariesCanvas"></canvas>
        <button id="cariesEndBtn" class="ui-btn">‚úÖ –ì–æ—Ç–æ–≤–æ!</button>
    </div>

    <!-- AR —Å—Ü–µ–Ω–∞ -->
    <a-scene
        mindar-image="imageTargetSrc: my-marker.mind; autoStart: true; maxTrackTime: 10000;"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false"
        loading-screen="enabled: false"
        embedded
        renderer="colorManagement: true; physicallyCorrectLights: true; alpha: true;"
        touch-gestures="targetId: tooth-model; initialScale: 0.3; minScale: 0.15; maxScale: 1.0; rotationSpeed: 0.5;"
    >
        <a-assets>
            <a-asset-item id="toothModel" src="assets/3d_models/a-gltf-model.glb"></a-asset-item>
            <audio id="bg-music" src="assets/audio/sound4.mp3" preload="auto" loop muted playsinline crossorigin="anonymous"></audio>
            <audio id="applauseSound" src="assets/audio/applause.mp3" preload="auto" muted playsinline crossorigin="anonymous"></audio>
            <audio id="toothClickSound" src="assets/audio/sound5.mp3" preload="auto" muted playsinline crossorigin="anonymous"></audio>
            <audio id="toothMessageSound" src="assets/audio/sound1.mp3" preload="auto" muted playsinline crossorigin="anonymous"></audio>
        </a-assets>
        
        <a-entity light="type: ambient; color: #FFFFFF; intensity: 1.0"></a-entity>
        <a-entity light="type: directional; color: #FFFFFF; intensity: 0.8" position="1 1 1"></a-entity>
        
        <a-camera look-controls="enabled: false" position="0 0 0">
            <a-cursor
                raycaster="objects: .clickable;"
                cursor="fuse: false; maxDistance: 10"
                position="0 0 -1"
                geometry="primitive: ring; radiusOuter: 0.015; radiusInner: 0.008"
                material="color: #FFD700; shader: flat"
            ></a-cursor>
        </a-camera>
        
        <a-entity mindar-image-target="targetIndex: 0" id="target-entity">
            <a-gltf-model
                id="tooth-model"
                class="clickable"
                src="#toothModel"
                scale="0.3 0.3 0.3"
                position="0 0 0.1"
                rotation="0 0 0"
                shadow
                animation-mixer="clip: Idle; loop: repeat; timeScale: 1.0; autoplay: true;"
            ></a-gltf-model>
        </a-entity>
    </a-scene>
    
    <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è -->
    <button id="soundBtn" class="ui-btn">üîä –ó–≤—É–∫</button>
    <button id="mainPlayBtn" class="ui-btn">‚ñ∂Ô∏è –ì–†–ê–¢–ò!</button>
    
    <button id="startGame1Btn" class="ui-btn">üçé –ì—Ä–∞ "–ó–¥–æ—Ä–æ–≤–∞ –á–∂–∞"</button>
    <button id="startGame2Btn" class="ui-btn">ü™• –ì—Ä–∞ "–ß–∏—Å—Ç–∫–∞"</button>
    <button id="startGame3Btn" class="ui-btn">üîç –ì—Ä–∞ "–ó–Ω–∞–π–¥–∏ –ö–∞—Ä–∏—î—Å"</button>
    <button id="rulesBtn" class="ui-btn">–Ø–∫ –≥—Ä–∞—Ç–∏?</button>
    
    <a href="https://www.youtube.com/@23smartlessa32?si=d3NhKDot8U8Mc2Hi" id="youtubeBtn" class="ui-btn" target="_blank" rel="noopener noreferrer">‚ù§Ô∏è –ê–≤—Ç–æ—Ä</a>
    <a href="https://nikadent-family.com.ua/ua/" id="aboutBtn" class="ui-btn" target="_blank" rel="noopener noreferrer">‚ÑπÔ∏è –ü—Ä–æ –Ω–∞—Å</a>
    <button id="resetRotationBtn" class="ui-btn">üîÑ –°–∫–∏–Ω—É—Ç–∏</button>
    <button id="returnBtn" class="ui-btn">üö™ –ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ –ó—É–±—á–∏–∫–∞</button>

    <script>
        // üéÆ –ö–õ–ê–° ARGame - –û–°–ù–û–í–ù–ê –õ–û–ì–Ü–ö–ê –ì–†–ò
        class ARGame {
            constructor() {
                // üèóÔ∏è –°–¢–ê–ù –ì–†–ò
                this.state = {
                    isGameRunning: false,
                    gameSelectionActive: false,
                    isTargetVisible: false,
                    isCleaningActive: false,
                    score: 0,
                    currentGame: null,
                    audioEnabled: false,
                    wasBgMusicPlaying: false
                };

                // ‚ö° –ü–†–û–î–£–ö–¢–ò–í–ù–Ü–°–¢–¨
                this.performance = {
                    lastFrameTime: 0,
                    fps: 0,
                    frameCount: 0,
                    lastFpsUpdate: 0
                };

                // üéØ –Ü–ì–†–û–í–Ü –ö–û–ù–°–¢–ê–ù–¢–ò
                this.constants = {
                    GAME1_DURATION: 45,
                    CLEANING_DURATION: 30,
                    CARIES_DURATION: 40,
                    ITEM_SIZE: 60,
                    FALL_SPEED_MULTIPLIER: 2.5,
                    BRUSH_SIZE: 80
                };

                // üì¶ –î–ê–ù–Ü –ì–†–ò
                this.gameData = {
                    fallingItems: [],
                    dirtPatches: [],
                    cariesSpots: [],
                    startTime: null,
                    lastSpawnTime: 0,
                    cleanedPatchesCount: 0,
                    foundCariesCount: 0
                };

                // üîó DOM –ï–õ–ï–ú–ï–ù–¢–ò
                this.elements = {};
                this.audio = {};
                
                // üéÆ –ê–ù–Ü–ú–ê–¶–Ü–á –¢–ê –¢–ê–ô–ú–ï–†–ò
                this.animationFrameId = null;
                this.gameTimerId = null;
                this.resizeTimeout = null;

                this.init();
            }

            // üöÄ –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø
            init() {
                this.cacheElements();
                this.initEventListeners();
                this.setupPerformanceMonitoring();
                this.setupErrorHandling();
                this.setupOptimizedResize();
                this.initGestureControls();
            }

            // üì¶ –ö–ï–®–£–í–ê–ù–ù–Ø –ï–õ–ï–ú–ï–ù–¢–Ü–í
            cacheElements() {
                this.elements = {
                    scene: document.querySelector('a-scene'),
                    loader: document.querySelector('#loader'),
                    targetEntity: document.querySelector('#target-entity'),
                    toothModel: document.querySelector('#tooth-model'),
                    
                    // –ö–Ω–æ–ø–∫–∏
                    mainPlayBtn: document.querySelector('#mainPlayBtn'),
                    startGame1Btn: document.querySelector('#startGame1Btn'),
                    startGame2Btn: document.querySelector('#startGame2Btn'),
                    startGame3Btn: document.querySelector('#startGame3Btn'),
                    rulesBtn: document.querySelector('#rulesBtn'),
                    soundBtn: document.querySelector('#soundBtn'),
                    returnBtn: document.querySelector('#returnBtn'),
                    resetRotationBtn: document.querySelector('#resetRotationBtn'),
                    
                    // UI
                    timerText: document.getElementById('timerText'),
                    scoreText: document.getElementById('scoreText'),
                    fpsIndicator: document.getElementById('fps-indicator'),
                    
                    // –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
                    endMessage: document.getElementById('endMessage'),
                    rulesMessage: document.getElementById('rulesMessage'),
                    listenMessage: document.getElementById('listenMessage'),
                    closeRulesBtn: document.getElementById('closeRulesBtn'),
                    listenBtn: document.getElementById('listenBtn'),
                    
                    // Canvas
                    gameCanvas: document.getElementById('gameCanvas'),
                    cleaningCanvas: document.getElementById('cleaningCanvas'),
                    cariesCanvas: document.getElementById('cariesCanvas'),
                    canvasContainer1: document.getElementById('canvasGameContainer'),
                    canvasContainer2: document.getElementById('cleaningGameContainer'),
                    canvasContainer3: document.getElementById('cariesGameContainer'),
                    brushElement: document.getElementById('brush'),
                    
                    // –ö–Ω–æ–ø–∫–∏ –≥—Ä–∏
                    endBtn: document.getElementById('endBtn'),
                    cleaningEndBtn: document.getElementById('cleaningEndBtn'),
                    cariesEndBtn: document.getElementById('cariesEndBtn')
                };

                this.audio = {
                    bgMusic: document.querySelector('#bg-music'),
                    applauseSound: document.querySelector('#applauseSound'),
                    toothClickSound: document.querySelector('#toothClickSound'),
                    toothMessageSound: document.querySelector('#toothMessageSound')
                };

                // –ö–æ–Ω—Ç–µ–∫—Å—Ç–∏ canvas
                this.ctx1 = this.elements.gameCanvas.getContext('2d');
                this.ctx2 = this.elements.cleaningCanvas.getContext('2d');
                this.ctx3 = this.elements.cariesCanvas.getContext('2d');
            }

            // üéØ –ü–Ü–î–ü–ò–°–ö–ê –ù–ê –ü–û–î–Ü–á
            initEventListeners() {
                // –ü–æ–¥—ñ—ó AR
                this.elements.targetEntity.addEventListener('targetFound', () => this.handleTargetFound());
                this.elements.targetEntity.addEventListener('targetLost', () => this.handleTargetLost());

                // –ü–æ–¥—ñ—ó –∫–Ω–æ–ø–æ–∫
                this.elements.toothModel.addEventListener('click', () => this.handleToothClick());
                this.elements.soundBtn.addEventListener('click', () => this.toggleSound());
                this.elements.mainPlayBtn.addEventListener('click', () => this.showGameSelectionMenu());
                this.elements.rulesBtn.addEventListener('click', () => this.showRules());
                this.elements.closeRulesBtn.addEventListener('click', () => this.closeRules());
                this.elements.listenBtn.addEventListener('click', () => this.handleListen());
                this.elements.returnBtn.addEventListener('click', () => this.returnToTooth());
                this.elements.resetRotationBtn.addEventListener('click', () => this.resetRotation());

                // –ü–æ–¥—ñ—ó —ñ–≥–æ—Ä
                this.elements.startGame1Btn.addEventListener('click', () => this.startCanvasGame('game1'));
                this.elements.startGame2Btn.addEventListener('click', () => this.startCanvasGame('game2'));
                this.elements.startGame3Btn.addEventListener('click', () => this.startCanvasGame('game3'));
            }

            // üõ°Ô∏è –û–ë–†–û–ë–ö–ê –ü–û–ú–ò–õ–û–ö
            setupErrorHandling() {
                window.addEventListener('error', (e) => {
                    console.error('Global error:', e.error);
                    this.showErrorScreen('–°—Ç–∞–ª–∞—Å—è –Ω–µ–æ—á—ñ–∫—É–≤–∞–Ω–∞ –ø–æ–º–∏–ª–∫–∞', e.error);
                });

                this.elements.scene.addEventListener('arError', (e) => {
                    console.error('AR Error:', e.detail);
                    this.showErrorScreen('–ü—Ä–æ–±–ª–µ–º–∞ –∑ AR –∫–∞–º–µ—Ä–æ—é', e.detail);
                });

                this.elements.scene.addEventListener('asset-error', (e) => {
                    console.error('Asset Error:', e.detail);
                    this.showFallbackContent();
                });

                // –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–µ–¥—ñ–∞
                Object.values(this.audio).forEach(audio => {
                    audio.addEventListener('error', (e) => {
                        console.warn('Audio load error:', e);
                    });
                });
            }

            showErrorScreen(message, error = null) {
                const errorHTML = `
                    <div class="error-screen state-screen smooth-transition">
                        <div class="error-content">
                            <div class="floating-animation" style="font-size: 4em;">üòû</div>
                            <h3>–©–æ—Å—å –ø—ñ—à–ª–æ –Ω–µ —Ç–∞–∫</h3>
                            <p>${message}</p>
                            ${error ? `<details><summary>–î–µ—Ç–∞–ª—ñ</summary><small>${error}</small></details>` : ''}
                            <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                                <button onclick="location.reload()" class="ui-btn">üîÑ –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –∑–Ω–æ–≤—É</button>
                                <button onclick="game.showBasicVersion()" class="ui-btn">üì± –ë–∞–∑–æ–≤–∏–π —Ä–µ–∂–∏–º</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', errorHTML);
            }

            showFallbackContent() {
                this.elements.loader.innerHTML = `
                    <div class="fallback-mode">
                        <h3>ü¶∑ –†–µ–∂–∏–º –±–µ–∑ AR</h3>
                        <p>–ì—Ä–∞–π —É –º—ñ–Ω—ñ-—ñ–≥—Ä–∏ –±–µ–∑ –∫–∞—Ä—Ç–∫–∏!</p>
                        <button onclick="game.startWithoutAR()" class="ui-btn pulse">üéÆ –ì—Ä–∞—Ç–∏</button>
                    </div>
                `;
            }

            showBasicVersion() {
                document.querySelector('.error-screen')?.remove();
                this.elements.scene.style.display = 'none';
                this.showGameSelectionMenu();
            }

            // ‚ö° –ü–†–û–î–£–ö–¢–ò–í–ù–Ü–°–¢–¨
            setupPerformanceMonitoring() {
                if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
                    this.monitorFPS();
                    this.elements.fpsIndicator.style.display = 'block';
                }
            }

            monitorFPS() {
                const updateFPS = (timestamp) => {
                    this.performance.frameCount++;
                    
                    if (timestamp >= this.performance.lastFpsUpdate + 1000) {
                        this.performance.fps = Math.round(
                            (this.performance.frameCount * 1000) / (timestamp - this.performance.lastFpsUpdate)
                        );
                        this.performance.frameCount = 0;
                        this.performance.lastFpsUpdate = timestamp;
                        this.updateFPSIndicator();
                    }
                    
                    requestAnimationFrame(updateFPS);
                };
                requestAnimationFrame(updateFPS);
            }

            updateFPSIndicator() {
                let color = '#4CAF50';
                if (this.performance.fps < 30) color = '#FF9800';
                if (this.performance.fps < 20) color = '#F44336';
                
                this.elements.fpsIndicator.style.background = color;
                this.elements.fpsIndicator.textContent = `FPS: ${this.performance.fps}`;
            }

            setupOptimizedResize() {
                window.addEventListener('resize', () => {
                    if (!this.resizeTimeout) {
                        this.resizeTimeout = setTimeout(() => {
                            this.resizeTimeout = null;
                            this.handleResize();
                        }, 250);
                    }
                });
            }

            handleResize() {
                const canvases = [
                    this.elements.gameCanvas, 
                    this.elements.cleaningCanvas, 
                    this.elements.cariesCanvas
                ];
                
                canvases.forEach(canvas => {
                    if (canvas && canvas.width !== window.innerWidth) {
                        canvas.width = window.innerWidth;
                        canvas.height = window.innerHeight;
                    }
                });
            }

            // üëÜ –ñ–ï–°–¢–ò –¢–ê –£–ü–†–ê–í–õ–Ü–ù–ù–Ø
            initGestureControls() {
                AFRAME.registerComponent('touch-gestures', {
                    schema: {
                        targetId: { type: 'string', default: 'tooth-model' },
                        initialScale: { type: 'number', default: 0.3 },
                        minScale: { type: 'number', default: 0.15 },
                        maxScale: { type: 'number', default: 1.0 },
                        rotationSpeed: { type: 'number', default: 0.5 }
                    },
                    init: function () {
                        this.isRotating = false;
                        this.isPinching = false;
                        this.startPos = { x: 0, y: 0 };
                        this.currentScale = this.data.initialScale;
                        this.targetEl = document.querySelector('#' + this.data.targetId);

                        if (!this.targetEl) {
                            console.error('3D –º–æ–¥–µ–ª—å –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞');
                            return;
                        }
                        
                        const scale = this.data.initialScale;
                        this.targetEl.object3D.scale.set(scale, scale, scale);
                        
                        const targetArea = this.el.sceneEl;

                        targetArea.addEventListener('touchstart', (e) => {
                            if (game.state.isGameRunning || game.state.gameSelectionActive || 
                                game.elements.rulesMessage.style.display === 'block' || 
                                game.elements.listenMessage.style.display === 'block') {
                                return;
                            }
                            
                            e.preventDefault();
                            if (e.touches.length === 1) {
                                this.isRotating = true;
                                this.startPos.x = e.touches[0].pageX;
                                this.startPos.y = e.touches[0].pageY;
                            } else if (e.touches.length === 2) {
                                this.isPinching = true;
                                this.isRotating = false;
                                this.initialDistance = Math.hypot(
                                    e.touches[0].pageX - e.touches[1].pageX,
                                    e.touches[0].pageY - e.touches[1].pageY
                                );
                                this.currentScale = this.targetEl.object3D.scale.x;
                            }
                        }, { passive: false });

                        targetArea.addEventListener('touchmove', (e) => {
                            if (game.state.isGameRunning || game.state.gameSelectionActive || 
                                game.elements.rulesMessage.style.display === 'block' || 
                                game.elements.listenMessage.style.display === 'block') {
                                return;
                            }
                            
                            e.preventDefault();
                            if (this.isPinching && e.touches.length === 2) {
                                const currentDistance = Math.hypot(
                                    e.touches[0].pageX - e.touches[1].pageX,
                                    e.touches[0].pageY - e.touches[1].pageY
                                );
                                const scaleFactor = currentDistance / this.initialDistance;
                                let newScale = this.currentScale * scaleFactor;

                                newScale = Math.max(this.data.minScale, Math.min(this.data.maxScale, newScale));
                                
                                this.targetEl.object3D.scale.set(newScale, newScale, newScale);
                            } else if (this.isRotating && e.touches.length === 1) {
                                const deltaX = (e.touches[0].pageX - this.startPos.x) * this.data.rotationSpeed;
                                const deltaY = (e.touches[0].pageY - this.startPos.y) * this.data.rotationSpeed;
                                
                                this.targetEl.object3D.rotation.y += THREE.MathUtils.degToRad(deltaX);
                                this.targetEl.object3D.rotation.x += THREE.MathUtils.degToRad(deltaY);

                                this.startPos.x = e.touches[0].pageX;
                                this.startPos.y = e.touches[0].pageY;
                            }
                        }, { passive: false });

                        targetArea.addEventListener('touchend', () => {
                            this.isRotating = false;
                            this.isPinching = false;
                        });
                    }
                });
            }

            // üéµ –ó–í–£–ö
            toggleSound() {
                const isMuted = !this.audio.bgMusic.muted;
                Object.values(this.audio).forEach(audio => audio.muted = isMuted);
                this.elements.soundBtn.textContent = isMuted ? "üîä –ó–≤—É–∫" : "üîá –ë–µ–∑ –∑–≤—É–∫—É";
                this.state.audioEnabled = !isMuted;

                if (!isMuted && this.state.isTargetVisible && !this.state.isGameRunning) {
                    this.playAudio(this.audio.bgMusic);
                    this.state.wasBgMusicPlaying = true;
                } else if (isMuted) {
                    this.audio.bgMusic.pause();
                    this.state.wasBgMusicPlaying = false;
                }
            }

            playAudio(audioElement) {
                if (!audioElement || !this.state.audioEnabled) return;
                
                audioElement.play().catch(error => {
                    console.warn('Audio play failed:', error);
                });
            }

            // ü¶∑ –í–ó–ê–Ñ–ú–û–î–Ü–Ø –ó –ó–£–ë–ß–ò–ö–û–ú
            handleToothClick() {
                if (!this.state.isGameRunning && !this.state.gameSelectionActive && 
                    this.elements.rulesMessage.style.display !== 'block' && 
                    this.elements.listenMessage.style.display !== 'block') {
                    
                    this.playAudio(this.audio.toothClickSound);
                    
                    const currentScale = this.elements.toothModel.object3D.scale.x;
                    this.elements.toothModel.setAttribute('animation__pulse', {
                        property: 'scale',
                        to: `${currentScale * 1.2} ${currentScale * 1.2} ${currentScale * 1.2}`,
                        dur: 200,
                        dir: 'alternate',
                        loop: 2
                    });
                    
                    this.showTemporaryMessage("ü¶∑ –ü–æ–∫—Ä—É—Ç–∏ –º–µ–Ω–µ –ø–∞–ª—å—á–∏–∫–æ–º, —â–æ–± —Ä–æ–∑–¥–∏–≤–∏—Ç–∏—Å—è! üòä", 3000);
                }
            }

            resetRotation() {
                if (!this.state.isGameRunning) {
                    this.elements.toothModel.object3D.rotation.set(0, 0, 0);
                    
                    const gestures = this.elements.scene.components['touch-gestures'];
                    const initialScale = gestures ? gestures.data.initialScale : 0.3;
                    this.elements.toothModel.object3D.scale.set(initialScale, initialScale, initialScale);
                    
                    this.showTemporaryMessage("ü¶∑ –ó—É–±—á–∏–∫ –ø–æ–≤–µ—Ä–Ω—É–≤—Å—è –Ω–∞ –º—ñ—Å—Ü–µ! üòä", 2000);
                }
            }

            // üéØ AR –£–ü–†–ê–í–õ–Ü–ù–ù–Ø
            handleTargetFound() {
                this.setState({ 
                    isTargetVisible: true 
                });
                this.elements.toothModel.object3D.visible = true;
                
                if (!this.audio.bgMusic.muted && !this.state.isGameRunning && this.state.wasBgMusicPlaying) {
                    this.playAudio(this.audio.bgMusic);
                }
            }

            handleTargetLost() {
                this.setState({ 
                    isTargetVisible: false 
                });
                this.state.wasBgMusicPlaying = !this.audio.bgMusic.muted && !this.audio.bgMusic.paused;
                if (!this.audio.bgMusic.paused) this.audio.bgMusic.pause();
            }

            // üèóÔ∏è –£–ü–†–ê–í–õ–Ü–ù–ù–Ø –°–¢–ê–ù–û–ú
            setState(newState) {
                this.state = { ...this.state, ...newState };
                this.updateUI();
            }

            updateUI() {
                const isMenuShown = this.elements.rulesMessage.style.display === 'block';
                const buttons = [
                    this.elements.soundBtn, this.elements.timerText, this.elements.scoreText, 
                    this.elements.returnBtn, this.elements.mainPlayBtn, this.elements.startGame1Btn,
                    this.elements.startGame2Btn, this.elements.startGame3Btn, this.elements.rulesBtn,
                    this.elements.resetRotationBtn, this.elements.listenMessage
                ];

                buttons.forEach(btn => btn.style.display = 'none');
                this.elements.loader.style.display = 'none';

                if (this.state.isGameRunning) {
                    this.elements.timerText.style.display = 'block';
                    this.elements.scoreText.style.display = 'block';
                    this.elements.returnBtn.style.display = 'block';
                } else if (this.state.isTargetVisible) {
                    this.elements.soundBtn.style.display = 'block';
                    this.elements.resetRotationBtn.style.display = 'block';

                    if (this.state.gameSelectionActive) {
                        if (!isMenuShown) {
                            this.elements.startGame1Btn.style.display = 'block';
                            this.elements.startGame2Btn.style.display = 'block';
                            this.elements.startGame3Btn.style.display = 'block';
                            this.elements.rulesBtn.style.display = 'block';
                        }
                        this.elements.listenMessage.style.display = 'none';
                    } else {
                        if (!isMenuShown) {
                            if (this.elements.listenMessage.style.display === 'block') {
                                this.elements.mainPlayBtn.style.display = 'none';
                            } else {
                                this.elements.mainPlayBtn.style.display = 'block';
                            }
                        }
                    }
                } else {
                    this.elements.loader.style.display = 'flex';
                }
            }

            // üì± UI –¢–ê –ù–ê–í–Ü–ì–ê–¶–Ü–Ø
            showTemporaryMessage(message, duration) {
                this.elements.endMessage.textContent = message;
                this.elements.endMessage.style.display = 'block';
                setTimeout(() => {
                    this.elements.endMessage.style.display = 'none';
                }, duration);
            }

            showRules() {
                this.elements.rulesMessage.style.display = 'block';
                this.updateUI();
            }

            closeRules() {
                this.elements.rulesMessage.style.display = 'none';
                this.showGameSelectionMenu();
            }

            showGameSelectionMenu() {
                this.setState({ 
                    gameSelectionActive: true 
                });
                this.elements.endMessage.style.display = 'none';
                this.elements.listenMessage.style.display = 'none';
                this.resumeSceneAndShowModel();
            }

            handleListen() {
                this.elements.listenMessage.style.display = 'none';

                if (this.audio.bgMusic.muted) {
                    Object.values(this.audio).forEach(audio => audio.muted = false);
                    this.elements.soundBtn.textContent = "üîá –ë–µ–∑ –∑–≤—É–∫—É";
                    this.state.audioEnabled = true;
                }

                this.state.wasBgMusicPlaying = !this.audio.bgMusic.muted && !this.audio.bgMusic.paused;

                if (this.audio.toothMessageSound) {
                    this.audio.bgMusic.pause();
                    this.audio.toothMessageSound.currentTime = 0;
                    this.playAudio(this.audio.toothMessageSound);
                }

                const messageDuration = this.audio.toothMessageSound && 
                    this.audio.toothMessageSound.duration && 
                    isFinite(this.audio.toothMessageSound.duration) ? 
                    this.audio.toothMessageSound.duration * 1000 + 500 : 3500;

                setTimeout(() => {
                    this.showGameSelectionMenu();
                }, messageDuration);
            }

            returnToTooth() {
                this.stopGame(false);
                this.resetToListenState();
            }

            resetToListenState() {
                this.setState({
                    isGameRunning: false,
                    gameSelectionActive: false
                });
                this.elements.listenMessage.style.display = this.state.isTargetVisible ? 'block' : 'none';
                this.elements.mainPlayBtn.style.display = 'none';
                this.updateUI();
            }

            // üéÆ –£–ü–†–ê–í–õ–Ü–ù–ù–Ø –ì–†–û–Æ
            startCanvasGame(gameType) {
                if (!this.state.isTargetVisible) return;

                this.setState({
                    isGameRunning: true,
                    gameSelectionActive: false,
                    score: 0
                });

                this.gameData.cleanedPatchesCount = 0;
                this.gameData.foundCariesCount = 0;
                this.elements.scoreText.textContent = `üåü –ë–∞–ª–∏: 0`;
                
                this.pauseSceneAndHideModel();
                
                this.state.wasBgMusicPlaying = !this.audio.bgMusic.muted && !this.audio.bgMusic.paused;
                if (!this.audio.bgMusic.paused) this.audio.bgMusic.pause();

                // –°—Ö–æ–≤–∞—Ç–∏ –≤—Å—ñ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏
                [
                    this.elements.canvasContainer1, 
                    this.elements.canvasContainer2, 
                    this.elements.canvasContainer3
                ].forEach(container => container.style.display = 'none');
                
                [
                    this.elements.endBtn, 
                    this.elements.cleaningEndBtn, 
                    this.elements.cariesEndBtn
                ].forEach(btn => btn.style.display = 'none');

                // –ó–∞–ø—É—Å–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ—ó –≥—Ä–∏
                if (gameType === 'game1') {
                    this.elements.canvasContainer1.style.display = 'block';
                    this.elements.endBtn.style.display = 'block';
                    this.initGame1();
                } else if (gameType === 'game2') {
                    this.elements.canvasContainer2.style.display = 'block';
                    this.elements.cleaningEndBtn.style.display = 'block';
                    this.initGame2();
                } else if (gameType === 'game3') {
                    this.elements.canvasContainer3.style.display = 'block';
                    this.elements.cariesEndBtn.style.display = 'block';
                    this.initCariesGame();
                }
            }

            stopGame(fromEnd = true) {
                this.setState({ 
                    isGameRunning: false 
                });
                
                cancelAnimationFrame(this.animationFrameId);
                clearTimeout(this.gameTimerId);

                // –í–∏–¥–∞–ª–µ–Ω–Ω—è –æ–±—Ä–æ–±–Ω–∏–∫—ñ–≤ –ø–æ–¥—ñ–π
                this.removeEventListeners();

                // –°—Ö–æ–≤–∞—Ç–∏ —ñ–≥—Ä–æ–≤—ñ –µ–ª–µ–º–µ–Ω—Ç–∏
                [
                    this.elements.canvasContainer1,
                    this.elements.canvasContainer2, 
                    this.elements.canvasContainer3,
                    this.elements.brushElement,
                    this.elements.endMessage,
                    this.elements.endBtn,
                    this.elements.cleaningEndBtn,
                    this.elements.cariesEndBtn
                ].forEach(el => el.style.display = 'none');

                this.resumeSceneAndShowModel();
                
                if (!this.audio.bgMusic.muted && this.state.wasBgMusicPlaying) {
                    this.playAudio(this.audio.bgMusic);
                }
            }

            removeEventListeners() {
                // –í–∏–¥–∞–ª–µ–Ω–Ω—è –≤—Å—ñ—Ö —ñ–≥—Ä–æ–≤–∏—Ö –æ–±—Ä–æ–±–Ω–∏–∫—ñ–≤
                this.elements.gameCanvas.removeEventListener('click', this.handleItemClick);
                this.elements.gameCanvas.removeEventListener('touchstart', this.handleItemClick);
                this.elements.endBtn.removeEventListener('click', this.endGame1);
                this.elements.cleaningCanvas.removeEventListener('mousedown', this.startClean);
                this.elements.cleaningCanvas.removeEventListener('mouseup', this.endClean);
                this.elements.cleaningCanvas.removeEventListener('mousemove', this.cleanPatch);
                this.elements.cleaningCanvas.removeEventListener('touchstart', this.startClean);
                this.elements.cleaningCanvas.removeEventListener('touchend', this.endClean);
                this.elements.cleaningCanvas.removeEventListener('touchmove', this.cleanPatch);
                this.elements.cleaningEndBtn.removeEventListener('click', this.endGame2);
                this.elements.cariesCanvas.removeEventListener('click', this.handleCariesClick);
                this.elements.cariesCanvas.removeEventListener('touchstart', this.handleCariesClick);
                this.elements.cariesEndBtn.removeEventListener('click', this.endCariesGame);
            }

            pauseSceneAndHideModel() {
                this.elements.scene.pause();
                this.elements.scene.style.display = 'none';
                this.elements.toothModel.object3D.visible = false;
            }

            resumeSceneAndShowModel() {
                this.elements.scene.style.display = 'block';
                this.elements.scene.play();
                if (this.state.isTargetVisible) {
                    this.elements.toothModel.object3D.visible = true;
                }
            }

            // üéÆ –ì–†–ê 1: –ó–î–û–†–û–í–ê –á–ñ–ê
            initGame1() {
                this.state.currentGame = 'game1';
                this.elements.gameCanvas.width = window.innerWidth;
                this.elements.gameCanvas.height = window.innerHeight;
                
                this.gameData.fallingItems = [];
                this.gameData.lastSpawnTime = Date.now();
                this.gameData.startTime = Date.now();
                
                this.elements.timerText.textContent = `‚è≥ –ß–∞—Å: ${String(this.constants.GAME1_DURATION).padStart(2, '0')}`;

                // –ü—Ä–∏–≤'—è–∑–∫–∞ –æ–±—Ä–æ–±–Ω–∏–∫—ñ–≤
                this.handleItemClick = this.handleItemClick.bind(this);
                this.endGame1 = this.endGame1.bind(this);
                
                this.elements.gameCanvas.addEventListener('click', this.handleItemClick);
                this.elements.gameCanvas.addEventListener('touchstart', this.handleItemClick, { passive: false });
                this.elements.endBtn.addEventListener('click', this.endGame1);

                this.gameTimerId = setTimeout(this.endGame1.bind(this), this.constants.GAME1_DURATION * 1000);
                this.animationFrameId = requestAnimationFrame(this.animateGame1.bind(this));
            }

            handleItemClick(e) {
                e.preventDefault();

                const rect = this.elements.gameCanvas.getBoundingClientRect();
                const clickX = (e.clientX || (e.touches && e.touches[0].clientX)) - rect.left;
                const clickY = (e.clientY || (e.touches && e.touches[0].clientY)) - rect.top;

                for (let i = this.gameData.fallingItems.length - 1; i >= 0; i--) {
                    const item = this.gameData.fallingItems[i];
                    if (clickX >= item.x && clickX <= item.x + this.constants.ITEM_SIZE &&
                        clickY >= item.y && clickY <= item.y + this.constants.ITEM_SIZE) {

                        if (item.isGood) {
                            this.state.score += 10;
                            this.playAudio(this.audio.toothClickSound);
                        } else {
                            this.state.score = Math.max(0, this.state.score - 5);
                        }
                        this.elements.scoreText.textContent = `üåü –ë–∞–ª–∏: ${this.state.score}`;
                        this.gameData.fallingItems.splice(i, 1);
                        break;
                    }
                }
            }

            spawnItem() {
                const goodItems = ['ü¶∑', 'ü™•', 'üçé', 'ü•ï', 'üíß', 'ü•õ', 'ü•¶', 'üçå'];
                const badItems = ['üçî', 'üçü', 'üçï', 'üç¶', 'üç≠', 'üç´', 'ü•§', 'üç∞'];
                const isGood = Math.random() > 0.4;
                const itemValue = isGood ? goodItems[Math.floor(Math.random() * goodItems.length)] : badItems[Math.floor(Math.random() * badItems.length)];

                this.gameData.fallingItems.push({
                    x: Math.random() * (this.elements.gameCanvas.width - this.constants.ITEM_SIZE),
                    y: -this.constants.ITEM_SIZE,
                    vy: 1.5 + Math.random() * this.constants.FALL_SPEED_MULTIPLIER,
                    value: itemValue,
                    isGood: isGood
                });
            }

            drawGame1() {
                this.ctx1.clearRect(0, 0, this.elements.gameCanvas.width, this.elements.gameCanvas.height);
                
                // –§–æ–Ω
                this.ctx1.fillStyle = '#E0F7FA';
                this.ctx1.fillRect(0, 0, this.elements.gameCanvas.width, this.elements.gameCanvas.height);
                
                // –•–º–∞—Ä–∏–Ω–∫–∏
                this.ctx1.fillStyle = 'rgba(255, 255, 255, 0.8)';
                this.ctx1.beginPath();
                this.ctx1.arc(100, 80, 30, 0, Math.PI * 2);
                this.ctx1.arc(130, 70, 40, 0, Math.PI * 2);
                this.ctx1.arc(160, 80, 35, 0, Math.PI * 2);
                this.ctx1.fill();
                
                this.ctx1.beginPath();
                this.ctx1.arc(this.elements.gameCanvas.width - 100, 120, 35, 0, Math.PI * 2);
                this.ctx1.arc(this.elements.gameCanvas.width - 130, 110, 45, 0, Math.PI * 2);
                this.ctx1.arc(this.elements.gameCanvas.width - 160, 120, 40, 0, Math.PI * 2);
                this.ctx1.fill();

                this.ctx1.font = `${this.constants.ITEM_SIZE}px 'Comic Neue', sans-serif`;
                this.ctx1.textAlign = 'center';
                this.ctx1.textBaseline = 'middle';

                // –ó—É–±—á–∏–∫ –≤–Ω–∏–∑—É
                this.ctx1.font = `${this.constants.ITEM_SIZE * 2}px 'Comic Neue', sans-serif`;
                this.ctx1.globalAlpha = 0.3;
                this.ctx1.fillText("ü¶∑", this.elements.gameCanvas.width / 2, this.elements.gameCanvas.height - 30);
                this.ctx1.globalAlpha = 1.0;

                this.ctx1.font = `${this.constants.ITEM_SIZE}px 'Comic Neue', sans-serif`;

                // –ú–∞–ª—é–≤–∞–Ω–Ω—è –ø—Ä–µ–¥–º–µ—Ç—ñ–≤
                this.gameData.fallingItems.forEach(item => {
                    if (item.isGood) {
                        this.ctx1.fillStyle = '#4CAF50';
                    } else {
                        this.ctx1.fillStyle = '#F44336';
                    }
                    this.ctx1.fillText(item.value, item.x + this.constants.ITEM_SIZE / 2, item.y + this.constants.ITEM_SIZE / 2);
                });
                
                // –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è
                this.ctx1.fillStyle = '#00796B';
                this.ctx1.font = '24px "Comic Neue", sans-serif';
                this.ctx1.textAlign = 'center';
                this.ctx1.fillText('üçé –õ–æ–≤–∏ –∑–¥–æ—Ä–æ–≤—É —ó–∂—É! üçî –£–Ω–∏–∫–∞–π —à–∫—ñ–¥–ª–∏–≤–æ—ó!', this.elements.gameCanvas.width / 2, 40);
            }

            animateGame1() {
                if (!this.state.isGameRunning || this.state.currentGame !== 'game1') return;

                const now = Date.now();
                const elapsedSeconds = Math.floor((now - this.gameData.startTime) / 1000);
                const timeLeft = this.constants.GAME1_DURATION - elapsedSeconds;
                this.elements.timerText.textContent = `‚è≥ –ß–∞—Å: ${String(timeLeft).padStart(2, '0')}`;

                if (timeLeft <= 0) {
                    this.endGame1();
                    return;
                }

                const spawnInterval = 600 - (elapsedSeconds * 10);

                if (now - this.gameData.lastSpawnTime > Math.max(150, spawnInterval)) {
                    this.spawnItem();
                    this.gameData.lastSpawnTime = now;
                }

                // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–æ–∑–∏—Ü—ñ–π
                this.gameData.fallingItems = this.gameData.fallingItems.filter(item => {
                    if (item.y < this.elements.gameCanvas.height + this.constants.ITEM_SIZE) {
                        item.y += item.vy;
                        return true;
                    }
                    if (item.isGood) {
                        this.state.score = Math.max(0, this.state.score - 5);
                        this.elements.scoreText.textContent = `üåü –ë–∞–ª–∏: ${this.state.score}`;
                    }
                    return false;
                });

                this.drawGame1();
                this.animationFrameId = requestAnimationFrame(this.animateGame1.bind(this));
            }

            endGame1() {
                cancelAnimationFrame(this.animationFrameId);
                clearTimeout(this.gameTimerId);
                
                this.elements.gameCanvas.removeEventListener('click', this.handleItemClick);
                this.elements.gameCanvas.removeEventListener('touchstart', this.handleItemClick);
                this.elements.endBtn.removeEventListener('click', this.endGame1);

                this.elements.canvasContainer1.style.display = 'none';
                this.elements.endBtn.style.display = 'none';

                this.elements.endMessage.textContent = `üéâ –ö–ª–∞—Å! –¢–∏ –∑–∞—Ä–æ–±–∏–≤ ${this.state.score} –±–∞–ª—ñ–≤! –•–æ—á–µ—à –ø–æ—á–∏—Å—Ç–∏—Ç–∏ –∑—É–±—á–∏–∫? üßº`;
                this.elements.endMessage.style.display = 'block';

                this.playAudio(this.audio.applauseSound);

                setTimeout(() => {
                    this.elements.endMessage.style.display = 'none';
                    this.stopGame(true);
                    this.resetToListenState();
                }, 3000);
            }

            // üéÆ –ì–†–ê 2: –ß–ò–°–¢–ö–ê –ó–£–ë–Ü–í
            initGame2() {
                this.state.currentGame = 'game2';
                this.elements.cleaningCanvas.width = window.innerWidth;
                this.elements.cleaningCanvas.height = window.innerHeight;
                
                this.gameData.dirtPatches = [];
                this.gameData.cleanedPatchesCount = 0;
                this.state.score = 0;
                this.elements.scoreText.textContent = `üåü –ë–∞–ª–∏: 0`;
                this.elements.brushElement.style.display = 'block';
                this.state.isCleaningActive = false;

                const centerX = this.elements.cleaningCanvas.width / 2;
                const centerY = this.elements.cleaningCanvas.height / 2;
                const toothRadius = Math.min(this.elements.cleaningCanvas.width, this.elements.cleaningCanvas.height) * 0.35;

                for (let i = 0; i < 7; i++) {
                    const angle = Math.random() * 2 * Math.PI;
                    const distance = toothRadius * (0.3 + Math.random() * 0.6);

                    this.gameData.dirtPatches.push({
                        x: centerX + distance * Math.cos(angle),
                        y: centerY + distance * Math.sin(angle),
                        radius: Math.random() * 20 + 30,
                        cleanPercentage: 0
                    });
                }

                this.drawGame2();
                
                // –ü—Ä–∏–≤'—è–∑–∫–∞ –æ–±—Ä–æ–±–Ω–∏–∫—ñ–≤
                this.startClean = this.startClean.bind(this);
                this.endClean = this.endClean.bind(this);
                this.cleanPatch = this.cleanPatch.bind(this);
                this.endGame2 = this.endGame2.bind(this);
                
                this.elements.cleaningCanvas.addEventListener('mousedown', this.startClean);
                this.elements.cleaningCanvas.addEventListener('mouseup', this.endClean);
                this.elements.cleaningCanvas.addEventListener('mousemove', this.cleanPatch);
                this.elements.cleaningCanvas.addEventListener('touchstart', this.startClean, { passive: false });
                this.elements.cleaningCanvas.addEventListener('touchend', this.endClean);
                this.elements.cleaningCanvas.addEventListener('touchmove', this.cleanPatch, { passive: false });
                this.elements.cleaningEndBtn.addEventListener('click', this.endGame2);

                this.gameData.startTime = Date.now();
                this.elements.timerText.textContent = `‚è≥ –ß–∞—Å: ${String(this.constants.CLEANING_DURATION).padStart(2, '0')}`;
                this.gameTimerId = setTimeout(this.endGame2.bind(this), this.constants.CLEANING_DURATION * 1000);
                this.animationFrameId = requestAnimationFrame(this.animateGame2.bind(this));
            }

            drawGame2() {
                this.ctx2.clearRect(0, 0, this.elements.cleaningCanvas.width, this.elements.cleaningCanvas.height);
                
                // –§–æ–Ω
                this.ctx2.fillStyle = 'rgba(224, 247, 250, 0.1)';
                this.ctx2.fillRect(0, 0, this.elements.cleaningCanvas.width, this.elements.cleaningCanvas.height);
                
                // –°–æ–Ω—è—á–Ω—ñ –ø—Ä–æ–º–µ–Ω—ñ
                this.ctx2.fillStyle = 'rgba(255, 255, 255, 0.3)';
                for (let i = 0; i < 8; i++) {
                    const angle = (i / 8) * Math.PI * 2;
                    this.ctx2.beginPath();
                    this.ctx2.moveTo(this.elements.cleaningCanvas.width / 2, this.elements.cleaningCanvas.height / 2);
                    this.ctx2.lineTo(
                        this.elements.cleaningCanvas.width / 2 + Math.cos(angle) * 400,
                        this.elements.cleaningCanvas.height / 2 + Math.sin(angle) * 400
                    );
                    this.ctx2.stroke();
                }

                // –ú–∞–ª—é–≤–∞–Ω–Ω—è –∑—É–±—á–∏–∫–∞
                this.ctx2.font = `${Math.min(this.elements.cleaningCanvas.width, this.elements.cleaningCanvas.height) * 0.6}px 'Comic Neue', sans-serif`;
                this.ctx2.textAlign = 'center';
                this.ctx2.textBaseline = 'middle';
                this.ctx2.fillText("ü¶∑", this.elements.cleaningCanvas.width / 2, this.elements.cleaningCanvas.height / 2);

                // –ú–∞–ª—é–≤–∞–Ω–Ω—è –±—Ä—É–¥—É
                this.gameData.dirtPatches.forEach(patch => {
                    if (patch.cleanPercentage < 100) {
                        this.ctx2.globalAlpha = 0.8 * (1 - patch.cleanPercentage / 100);
                        this.ctx2.fillStyle = 'rgb(100, 50, 20)';
                        this.ctx2.beginPath();
                        this.ctx2.arc(patch.x, patch.y, patch.radius, 0, 2 * Math.PI);
                        this.ctx2.fill();
                    }
                });
                this.ctx2.globalAlpha = 1.0;
                
                // –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è
                this.ctx2.fillStyle = '#00796B';
                this.ctx2.font = '24px "Comic Neue", sans-serif';
                this.ctx2.textAlign = 'center';
                this.ctx2.fillText('ü™• –ß–∏—Å—Ç–∏ –∑—É–±—á–∏–∫ —â—ñ—Ç–∫–æ—é!', this.elements.cleaningCanvas.width / 2, 40);
            }

            startClean(e) {
                e.preventDefault();
                this.state.isCleaningActive = true;
            }

            endClean(e) {
                this.state.isCleaningActive = false;
            }

            cleanPatch(e) {
                if (!this.state.isCleaningActive) return;
                e.preventDefault();

                const rect = this.elements.cleaningCanvas.getBoundingClientRect();
                const currentX = (e.clientX || (e.touches && e.touches[0].clientX)) - rect.left;
                const currentY = (e.clientY || (e.touches && e.touches[0].clientY)) - rect.top;

                this.elements.brushElement.style.left = `${currentX - this.constants.BRUSH_SIZE / 2}px`;
                this.elements.brushElement.style.top = `${currentY - this.constants.BRUSH_SIZE / 2}px`;

                let patchesCleaned = false;

                this.gameData.dirtPatches.forEach(patch => {
                    if (patch.cleanPercentage < 100) {
                        const distance = Math.sqrt(Math.pow(patch.x - currentX, 2) + Math.pow(patch.y - currentY, 2));

                        if (distance < patch.radius + this.constants.BRUSH_SIZE / 4) {
                            patch.cleanPercentage += 2;
                            if (patch.cleanPercentage >= 100) {
                                patch.cleanPercentage = 100;
                                this.gameData.cleanedPatchesCount++;
                                this.state.score += 10;
                                this.elements.scoreText.textContent = `üåü –ë–∞–ª–∏: ${this.state.score}`;
                                patchesCleaned = true;
                                this.playAudio(this.audio.toothClickSound);
                            }
                        }
                    }
                });

                if (patchesCleaned) {
                    this.drawGame2();
                }

                if (this.gameData.cleanedPatchesCount === this.gameData.dirtPatches.length) {
                    this.endGame2();
                }
            }

            animateGame2() {
                if (!this.state.isGameRunning || this.state.currentGame !== 'game2') return;

                const elapsedSeconds = Math.floor((Date.now() - this.gameData.startTime) / 1000);
                const timeLeft = this.constants.CLEANING_DURATION - elapsedSeconds;
                this.elements.timerText.textContent = `‚è≥ –ß–∞—Å: ${String(timeLeft).padStart(2, '0')}`;

                if (timeLeft <= 0) {
                    this.endGame2();
                    return;
                }

                this.drawGame2();
                this.animationFrameId = requestAnimationFrame(this.animateGame2.bind(this));
            }

            makeToothSmile() {
                this.elements.toothModel.setAttribute('animation-mixer', {
                    clip: 'Smile',
                    loop: 'repeat',
                    timeScale: 1.0,
                    autoplay: true
                });
                
                this.elements.toothModel.setAttribute('animation__pulse', {
                    property: 'scale',
                    to: '0.35 0.35 0.35',
                    dur: 1000,
                    dir: 'alternate',
                    loop: true,
                    easing: 'easeInOutSine'
                });
                
                this.elements.endMessage.textContent = "üòä –ó—É–±—á–∏–∫ —â–∞—Å–ª–∏–≤–∏–π —ñ —Å—è—î! –ú–æ–ª–æ–¥–µ—Ü—å!";
                this.elements.endMessage.style.display = 'block';
            }

            resetToothAnimation() {
                this.elements.toothModel.setAttribute('animation-mixer', {
                    clip: 'Idle',
                    loop: 'repeat',
                    timeScale: 1.0,
                    autoplay: true
                });
                
                this.elements.toothModel.removeAttribute('animation__pulse');
                
                const gestures = this.elements.scene.components['touch-gestures'];
                const initialScale = gestures ? gestures.data.initialScale : 0.3;
                this.elements.toothModel.object3D.scale.set(initialScale, initialScale, initialScale);
            }

            endGame2() {
                cancelAnimationFrame(this.animationFrameId);
                clearTimeout(this.gameTimerId);
                
                this.elements.cleaningCanvas.removeEventListener('mousedown', this.startClean);
                this.elements.cleaningCanvas.removeEventListener('mouseup', this.endClean);
                this.elements.cleaningCanvas.removeEventListener('mousemove', this.cleanPatch);
                this.elements.cleaningCanvas.removeEventListener('touchstart', this.startClean);
                this.elements.cleaningCanvas.removeEventListener('touchend', this.endClean);
                this.elements.cleaningCanvas.removeEventListener('touchmove', this.cleanPatch);
                this.elements.cleaningEndBtn.removeEventListener('click', this.endGame2);

                this.elements.canvasContainer2.style.display = 'none';
                this.elements.brushElement.style.display = 'none';
                this.elements.cleaningEndBtn.style.display = 'none';

                let finalMessage = `üéâ –ß—É–¥–æ–≤–æ! –¢–∏ –ø–æ—á–∏—Å—Ç–∏–≤ ${this.gameData.cleanedPatchesCount} –ø–ª—è–º! –ë–∞–ª–∏: ${this.state.score}!`;
                if (this.gameData.cleanedPatchesCount === this.gameData.dirtPatches.length) {
                    finalMessage = `üèÜ –¢–∏ –ø–µ—Ä–µ–º—ñ–≥! –ó—É–±—á–∏–∫ —Å—è—î! –ë–∞–ª–∏: ${this.state.score}!`;
                    this.playAudio(this.audio.applauseSound);
                    
                    setTimeout(() => {
                        this.resumeSceneAndShowModel();
                        this.makeToothSmile();
                    }, 1000);
                }

                this.elements.endMessage.textContent = finalMessage;
                this.elements.endMessage.style.display = 'block';

                setTimeout(() => {
                    this.elements.endMessage.style.display = 'none';
                    this.stopGame(true);
                    this.resetToothAnimation();
                    this.resetToListenState();
                }, 4000);
            }

            // üéÆ –ì–†–ê 3: –ó–ù–ê–ô–î–ò –ö–ê–†–ò–Ñ–°
            initCariesGame() {
                this.state.currentGame = 'game3';
                this.elements.cariesCanvas.width = window.innerWidth;
                this.elements.cariesCanvas.height = window.innerHeight;
                
                this.gameData.cariesSpots = [];
                this.gameData.foundCariesCount = 0;
                this.state.score = 0;
                this.elements.scoreText.textContent = `üåü –ë–∞–ª–∏: 0`;
                
                // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–∞—Ä–∏—î—Å–Ω–∏—Ö –ø–ª—è–º
                const numSpots = 8;
                for (let i = 0; i < numSpots; i++) {
                    this.gameData.cariesSpots.push({
                        x: Math.random() * (this.elements.cariesCanvas.width - 80) + 40,
                        y: Math.random() * (this.elements.cariesCanvas.height - 150) + 50,
                        radius: Math.random() * 15 + 20,
                        found: false,
                        id: i
                    });
                }
                
                this.drawCariesGame();
                
                // –ü—Ä–∏–≤'—è–∑–∫–∞ –æ–±—Ä–æ–±–Ω–∏–∫—ñ–≤
                this.handleCariesClick = this.handleCariesClick.bind(this);
                this.endCariesGame = this.endCariesGame.bind(this);
                
                this.elements.cariesCanvas.addEventListener('click', this.handleCariesClick);
                this.elements.cariesCanvas.addEventListener('touchstart', this.handleCariesClick, { passive: false });
                this.elements.cariesEndBtn.addEventListener('click', this.endCariesGame);
                
                this.gameData.startTime = Date.now();
                this.elements.timerText.textContent = `‚è≥ –ß–∞—Å: ${String(this.constants.CARIES_DURATION).padStart(2, '0')}`;
                this.gameTimerId = setTimeout(this.endCariesGame.bind(this), this.constants.CARIES_DURATION * 1000);
                this.animationFrameId = requestAnimationFrame(this.animateCariesGame.bind(this));
            }

            drawCariesGame() {
                this.ctx3.clearRect(0, 0, this.elements.cariesCanvas.width, this.elements.cariesCanvas.height);
                
                // –§–æ–Ω
                this.ctx3.fillStyle = '#E0F7FA';
                this.ctx3.fillRect(0, 0, this.elements.cariesCanvas.width, this.elements.cariesCanvas.height);
                
                // –ó—É–±—á–∏–∫
                this.ctx3.font = `${Math.min(this.elements.cariesCanvas.width, this.elements.cariesCanvas.height) * 0.6}px 'Comic Neue', sans-serif`;
                this.ctx3.textAlign = 'center';
                this.ctx3.textBaseline = 'middle';
                this.ctx3.fillText("ü¶∑", this.elements.cariesCanvas.width / 2, this.elements.cariesCanvas.height / 2);
                
                // –ö–∞—Ä–∏—î—Å–Ω—ñ –ø–ª—è–º–∏
                this.gameData.cariesSpots.forEach(spot => {
                    if (!spot.found) {
                        this.ctx3.fillStyle = 'rgba(139, 69, 19, 0.8)';
                        this.ctx3.beginPath();
                        this.ctx3.arc(spot.x, spot.y, spot.radius, 0, 2 * Math.PI);
                        this.ctx3.fill();
                        
                        this.ctx3.fillStyle = 'rgba(101, 67, 33, 0.9)';
                        this.ctx3.beginPath();
                        this.ctx3.arc(spot.x - 5, spot.y - 5, spot.radius * 0.4, 0, 2 * Math.PI);
                        this.ctx3.fill();
                    } else {
                        this.ctx3.fillStyle = 'rgba(255, 255, 255, 0.9)';
                        this.ctx3.beginPath();
                        this.ctx3.arc(spot.x, spot.y, spot.radius * 0.7, 0, 2 * Math.PI);
                        this.ctx3.fill();
                    }
                });
                
                // –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è
                this.ctx3.font = '24px "Comic Neue", sans-serif';
                this.ctx3.fillStyle = '#00796B';
                this.ctx3.textAlign = 'center';
                this.ctx3.fillText('üîç –ó–Ω–∞–π–¥–∏ –≤—Å—ñ –ø–ª—è–º–∏ –∫–∞—Ä–∏—î—Å—É!', this.elements.cariesCanvas.width / 2, 40);
            }

            handleCariesClick(e) {
                const rect = this.elements.cariesCanvas.getBoundingClientRect();
                const clickX = (e.clientX || (e.touches && e.touches[0].clientX)) - rect.left;
                const clickY = (e.clientY || (e.touches && e.touches[0].clientY)) - rect.top;
                
                this.gameData.cariesSpots.forEach(spot => {
                    if (!spot.found) {
                        const distance = Math.sqrt(Math.pow(spot.x - clickX, 2) + Math.pow(spot.y - clickY, 2));
                        
                        if (distance < spot.radius) {
                            spot.found = true;
                            this.gameData.foundCariesCount++;
                            this.state.score += 15;
                            this.elements.scoreText.textContent = `üåü –ë–∞–ª–∏: ${this.state.score}`;
                            this.playAudio(this.audio.toothClickSound);
                            
                            this.createParticles(spot.x, spot.y);
                            
                            if (this.gameData.foundCariesCount === this.gameData.cariesSpots.length) {
                                this.endCariesGame();
                            }
                        }
                    }
                });
                
                this.drawCariesGame();
            }

            createParticles(x, y) {
                for (let i = 0; i < 8; i++) {
                    setTimeout(() => {
                        this.ctx3.fillStyle = ['#FFD700', '#4CAF50', '#87CEEB'][i % 3];
                        this.ctx3.beginPath();
                        this.ctx3.arc(
                            x + (Math.random() - 0.5) * 50,
                            y + (Math.random() - 0.5) * 50,
                            Math.random() * 5 + 2,
                            0,
                            2 * Math.PI
                        );
                        this.ctx3.fill();
                    }, i * 50);
                }
            }

            animateCariesGame() {
                if (!this.state.isGameRunning || this.state.currentGame !== 'game3') return;
                
                const elapsedSeconds = Math.floor((Date.now() - this.gameData.startTime) / 1000);
                const timeLeft = this.constants.CARIES_DURATION - elapsedSeconds;
                this.elements.timerText.textContent = `‚è≥ –ß–∞—Å: ${String(timeLeft).padStart(2, '0')}`;
                
                if (timeLeft <= 0) {
                    this.endCariesGame();
                    return;
                }
                
                this.animationFrameId = requestAnimationFrame(this.animateCariesGame.bind(this));
            }

            endCariesGame() {
                cancelAnimationFrame(this.animationFrameId);
                clearTimeout(this.gameTimerId);
                
                this.elements.cariesCanvas.removeEventListener('click', this.handleCariesClick);
                this.elements.cariesCanvas.removeEventListener('touchstart', this.handleCariesClick);
                this.elements.cariesEndBtn.removeEventListener('click', this.endCariesGame);
                
                this.elements.canvasContainer3.style.display = 'none';
                this.elements.cariesEndBtn.style.display = 'none';
                
                let message = '';
                if (this.gameData.foundCariesCount === this.gameData.cariesSpots.length) {
                    message = `üèÜ –í—ñ—Ç–∞—é! –¢–∏ –∑–Ω–∞–π—à–æ–≤ –≤—Å—ñ ${this.gameData.foundCariesCount} –ø–ª—è–º –∫–∞—Ä–∏—î—Å—É! –ë–∞–ª–∏: ${this.state.score}!`;
                    this.playAudio(this.audio.applauseSound);
                    
                    setTimeout(() => {
                        this.resumeSceneAndShowModel();
                        this.makeToothSmile();
                    }, 1000);
                } else {
                    message = `‚ú® –ù–µ–ø–æ–≥–∞–Ω–æ! –ó–Ω–∞–π–¥–µ–Ω–æ ${this.gameData.foundCariesCount}/${this.gameData.cariesSpots.length} –ø–ª—è–º. –ë–∞–ª–∏: ${this.state.score}!`;
                }
                
                this.elements.endMessage.textContent = message;
                this.elements.endMessage.style.display = 'block';
                
                setTimeout(() => {
                    this.elements.endMessage.style.display = 'none';
                    this.stopGame(true);
                    this.resetToothAnimation();
                    this.resetToListenState();
                }, 4000);
            }

            // üèÜ –ï–ö–†–ê–ù –ü–ï–†–ï–ú–û–ì–ò
            showVictoryScreen(score, message) {
                const victoryHTML = `
                    <div class="victory-screen state-screen smooth-transition backdrop-blur">
                        <div class="victory-content pulse-glow">
                            <div class="floating-animation" style="font-size: 4em;">üéâ</div>
                            <h3>–ü–µ—Ä–µ–º–æ–≥–∞!</h3>
                            <div class="score-display">${score} –±–∞–ª—ñ–≤</div>
                            <p>${message}</p>
                            <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                                <button onclick="game.showGameSelectionMenu()" class="ui-btn pulse">‚û°Ô∏è –ù–∞—Å—Ç—É–ø–Ω–∞ –≥—Ä–∞</button>
                                <button onclick="game.returnToTooth()" class="ui-btn">üè† –ì–æ–ª–æ–≤–Ω–∞</button>
                            </div>
                        </div>
                    </div>
                `;
                
                this.fadeInElement(victoryHTML);
            }

            fadeInElement(html) {
                const temp = document.createElement('div');
                temp.innerHTML = html;
                const element = temp.firstElementChild;
                element.style.opacity = '0';
                
                document.body.appendChild(element);
                
                requestAnimationFrame(() => {
                    element.style.transition = 'opacity 0.5s ease';
                    element.style.opacity = '1';
                });
            }
        }

        // üöÄ –ó–ê–ü–£–°–ö –ì–†–ò
        let game;

        function initializeGame() {
            try {
                game = new ARGame();
                
                // –ê–¥–∞–ø—Ç–∞—Ü—ñ—è –≤–∏—Å–æ—Ç–∏ –¥–ª—è –º–æ–±—ñ–ª—å–Ω–∏—Ö –ø—Ä–∏—Å—Ç—Ä–æ—ó–≤
                function fixHeight() {
                    document.documentElement.style.height = window.innerHeight + 'px';
                }
                fixHeight();
                window.addEventListener('resize', fixHeight);
                
                console.log('ü¶∑ –ì—Ä–∞ "–ó—É–±—á–∏–∫-–í–µ—Å–µ–ª—É–Ω—á–∏–∫" —É—Å–ø—ñ—à–Ω–æ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞!');
            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó –≥—Ä–∏:', error);
                
                // –ï–∫—Ä–∞–Ω –ø–æ–º–∏–ª–∫–∏ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó
                const errorHTML = `
                    <div class="error-screen state-screen">
                        <div class="error-content">
                            <div style="font-size: 4em;">üòû</div>
                            <h3>–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</h3>
                            <p>–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç–∏ –≥—Ä—É. –°–ø—Ä–æ–±—É–π—Ç–µ –æ–Ω–æ–≤–∏—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫—É.</p>
                            <button onclick="location.reload()" class="ui-btn">üîÑ –û–Ω–æ–≤–∏—Ç–∏</button>
                        </div>
                    </div>
                `;
                document.body.innerHTML = errorHTML;
            }
        }

        // –ó–∞–ø—É—Å–∫ –ø—ñ—Å–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeGame);
        } else {
            initializeGame();
        }
    </script>
</body>
</html>
